---
import { ClientRouter } from 'astro:transitions';
import SEO from '../components/SEO.astro';
import '../styles/global.css';
import Header from '../components/Header.astro';
import Container from '../components/ui/Container.astro';

// Preload critical fonts
import fontDisplay from '../assets/fonts/PPNeueMachina-Light.woff2';
import fontBody from '../assets/fonts/PPNeueMontreal-Regular.woff2';

interface Props {
  // SEO props
  title: string;
  description: string;
  robots?: 'index, follow' | 'noindex, follow' | 'noindex, nofollow';
  canonical?: string;
  ogType?: 'website' | 'article';
  ogImage?: string;
  ogImageAlt?: string;
  twitterCard?: 'summary' | 'summary_large_image';
  publishedTime?: string;
  modifiedTime?: string;
  author?: string;
  siteNameAsPrefix?: boolean;

  // Layout props
  class?: string;
  variant?: 'light' | 'dark';
  headerVariant?: 'light' | 'dark';
}

const {
  title,
  description,
  robots,
  canonical,
  ogType,
  ogImage,
  ogImageAlt,
  twitterCard,
  publishedTime,
  modifiedTime,
  author,
  siteNameAsPrefix,
  class: className,
  variant = 'light',
  headerVariant,
} = Astro.props;

const isDark = variant === 'dark';
const bodyClasses = isDark ? 'bg-black text-bg-light' : 'bg-bg text-black';
const finalHeaderVariant = headerVariant ?? variant;

// Get locale from site settings for lang attribute
let lang = 'fr';
try {
  const reader = await import('../../keystatic.config').then(async (mod) => {
    const { createReader } = await import('@keystatic/core/reader');
    return createReader({ config: mod.default });
  });
  const settings = await reader.singletons.siteSettings.read();
  if (settings?.locale) {
    lang = settings.locale.split('_')[0];
  }
} catch {
  // Use default lang
}
---

<!doctype html>
<html lang={lang}>
  <head>
    <!-- Preload critical fonts for faster LCP -->
    <link rel="preload" href={fontDisplay} as="font" type="font/woff2" crossorigin />
    <link rel="preload" href={fontBody} as="font" type="font/woff2" crossorigin />

    <SEO
      title={title}
      description={description}
      robots={robots}
      canonical={canonical}
      ogType={ogType}
      ogImage={ogImage}
      ogImageAlt={ogImageAlt}
      twitterCard={twitterCard}
      publishedTime={publishedTime}
      modifiedTime={modifiedTime}
      author={author}
      siteNameAsPrefix={siteNameAsPrefix}
    />
    <ClientRouter />
  </head>
  <body class={`${bodyClasses} ${className || ''}`}>
    <a href="#main-content" class="skip-link">Aller au contenu principal</a>

    <Header variant={finalHeaderVariant} />
    <Container variant={variant}>
      <main id="main-content">
        <slot />
      </main>

      <slot name="footer" />
    </Container>
  </body>
</html>

<style is:global>
  *,
  *::before,
  *::after {
    box-sizing: border-box;
  }


  html {
    -webkit-text-size-adjust: 100%;
    -moz-tab-size: 4;
    tab-size: 4;
  }

  body {
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
    font-family: 'PP Neue Montreal';
  }

  img,
  picture,
  video,
  canvas,
  svg {
    max-width: 100%;
  }

  a {
    color: inherit;
    text-decoration: inherit;
  }

  /* Skip link for accessibility */
  .skip-link {
    position: absolute;
    top: -100%;
    left: 0;
    z-index: 9999;
    padding: 1rem;
    background: var(--color-primary, #000);
    color: var(--color-on-primary, #fff);
    text-decoration: underline;
  }

  .skip-link:focus {
    top: 0;
  }

  /* Respect reduced motion preference (WCAG 2.1 AA)
  @media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
      scroll-behavior: auto !important;
    }
  } */

  /* Lenis */
  html.lenis, html.lenis body {
    height: auto;
  }

  .lenis.lenis-smooth {
    scroll-behavior: auto !important;
  }

  .lenis.lenis-smooth [data-lenis-prevent] {
    overscroll-behavior: contain;
  }

  .lenis.lenis-stopped {
    overflow: hidden;
  }

  .lenis.lenis-smooth iframe {
    pointer-events: none;
  }
</style>

<script>
  import Lenis from 'lenis';

  const isMobile = window.matchMedia('(max-width: 768px)').matches;

  const lenis = new Lenis({
    touchMultiplier: isMobile ? 3.5 : 1,
  });

  // Exposer Lenis globalement pour le smooth scroll
  (window as any).lenis = lenis;

  function raf(time: number) {
    lenis.raf(time);
    requestAnimationFrame(raf);
  }

  requestAnimationFrame(raf);

  // Re-init on view transitions
  document.addEventListener('astro:after-swap', () => {
    lenis.scrollTo(0, { immediate: true });
  });
</script>
