---
import { ClientRouter } from 'astro:transitions';
import SEO from '../components/SEO.astro';
import '../styles/global.css';
import Header from '../components/Header.astro';
import HeaderNew from '../components/HeaderNew.astro';
import Container from '../components/ui/Container.astro';
import { DEFAULT_LOCALE, type Locale, useTranslations } from '../i18n';

// Preload critical fonts
import fontDisplay from '../assets/fonts/PPNeueMachina-Light.woff2';
import fontBody from '../assets/fonts/PPNeueMontreal-Regular.woff2';

interface Props {
  // i18n
  lang?: Locale;

  // SEO props
  title: string;
  description: string;
  robots?: 'index, follow' | 'noindex, follow' | 'noindex, nofollow';
  canonical?: string;
  ogType?: 'website' | 'article';
  ogImage?: string;
  ogImageAlt?: string;
  twitterCard?: 'summary' | 'summary_large_image';
  publishedTime?: string;
  modifiedTime?: string;
  author?: string;
  siteNameAsPrefix?: boolean;

  // Layout props
  class?: string;
  variant?: 'light' | 'dark';
  headerVariant?: 'light' | 'dark';
}

const {
  lang = DEFAULT_LOCALE,
  title,
  description,
  robots,
  canonical,
  ogType,
  ogImage,
  ogImageAlt,
  twitterCard,
  publishedTime,
  modifiedTime,
  author,
  siteNameAsPrefix,
  class: className,
  variant = 'light',
  headerVariant,
} = Astro.props;

const t = useTranslations(lang);
const isDark = variant === 'dark';
const bodyClasses = isDark ? 'bg-black text-bg-light' : 'bg-bg text-black';
const finalHeaderVariant = headerVariant ?? variant;
---

<!doctype html>
<html lang={lang}>
  <head>
    <!-- Preload critical fonts for faster LCP -->
    <link rel="preload" href={fontDisplay} as="font" type="font/woff2" crossorigin />
    <link rel="preload" href={fontBody} as="font" type="font/woff2" crossorigin />

    <SEO
      lang={lang}
      title={title}
      description={description}
      robots={robots}
      canonical={canonical}
      ogType={ogType}
      ogImage={ogImage}
      ogImageAlt={ogImageAlt}
      twitterCard={twitterCard}
      publishedTime={publishedTime}
      modifiedTime={modifiedTime}
      author={author}
      siteNameAsPrefix={siteNameAsPrefix}
    />
    <ClientRouter />
  </head>
  <body class={`${bodyClasses} ${className || ''}`}>
    <a href="#main-content" class="skip-link">{t.a11y.skipToContent}</a>

    <!-- <Header lang={lang} variant={finalHeaderVariant} /> -->
    <HeaderNew lang={lang} />
    <Container variant={variant}>
      <main id="main-content">
        <slot />
      </main>

      <slot name="footer" />
    </Container>
  </body>
</html>

<style is:global>
  *,
  *::before,
  *::after {
    box-sizing: border-box;
  }


  html {
    -webkit-text-size-adjust: 100%;
    -moz-tab-size: 4;
    tab-size: 4;
  }

  body {
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
    font-family: 'PP Neue Montreal';
  }

  img,
  picture,
  video,
  canvas,
  svg {
    max-width: 100%;
  }

  a {
    color: inherit;
    text-decoration: inherit;
  }

  /* Skip link for accessibility */
  .skip-link {
    position: absolute;
    top: -100%;
    left: 0;
    z-index: 9999;
    padding: 1rem;
    background: var(--color-primary, #000);
    color: var(--color-on-primary, #fff);
    text-decoration: underline;
  }

  .skip-link:focus {
    top: 0;
  }

  /* Respect reduced motion preference (WCAG 2.1 AA)
  @media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
      scroll-behavior: auto !important;
    }
  } */

  /* Lenis */
  html.lenis, html.lenis body {
    height: auto;
  }

  .lenis.lenis-smooth {
    scroll-behavior: auto !important;
  }

  .lenis.lenis-smooth [data-lenis-prevent] {
    overscroll-behavior: contain;
  }

  .lenis.lenis-stopped {
    overflow: hidden;
  }

  .lenis.lenis-smooth iframe {
    pointer-events: none;
  }
</style>

<script>
  // Lenis chargé dynamiquement après première interaction (scroll/touch/wheel)
  let lenisLoaded = false;

  async function initLenis() {
    if (lenisLoaded) return;
    lenisLoaded = true;

    const { default: Lenis } = await import('lenis');
    const isMobile = window.matchMedia('(max-width: 768px)').matches;

    const lenis = new Lenis({
      touchMultiplier: isMobile ? 3.5 : 1,
    });

    (window as any).lenis = lenis;

    function raf(time: number) {
      lenis.raf(time);
      requestAnimationFrame(raf);
    }
    requestAnimationFrame(raf);

    document.addEventListener('astro:after-swap', () => {
      lenis.scrollTo(0, { immediate: true });
    });

    // Cleanup listeners
    window.removeEventListener('wheel', initLenis);
    window.removeEventListener('touchstart', initLenis);
  }

  // Charger Lenis au premier scroll/touch
  window.addEventListener('wheel', initLenis, { once: true, passive: true });
  window.addEventListener('touchstart', initLenis, { once: true, passive: true });

  // Ou après idle si pas d'interaction
  if ('requestIdleCallback' in window) {
    requestIdleCallback(() => initLenis(), { timeout: 3000 });
  }
</script>

<script>
  // Smooth scroll pour les liens d'ancre
  function initAnchorScroll() {
    document.addEventListener('click', (e) => {
      const link = (e.target as HTMLElement).closest('a[href*="#"]');
      if (!link) return;

      const href = link.getAttribute('href');
      if (!href) return;

      const hashIndex = href.indexOf('#');
      if (hashIndex === -1) return;

      const path = href.substring(0, hashIndex);
      const hash = href.substring(hashIndex);
      const currentPath = window.location.pathname;

      // Vérifier si on est sur la bonne page (ou lien relatif)
      const isCurrentPage = !path || path === currentPath ||
        (path.endsWith('/') && currentPath === path.slice(0, -1)) ||
        (currentPath.endsWith('/') && path === currentPath.slice(0, -1));

      if (isCurrentPage && hash) {
        e.preventDefault();
        const target = document.querySelector(hash);
        if (target && (window as any).lenis) {
          (window as any).lenis.scrollTo(target, { duration: 1.2, offset: -100 });
        } else if (target) {
          target.scrollIntoView({ behavior: 'smooth' });
        }
        history.pushState(null, '', hash);
      } else if (path && hash) {
        // Navigation vers autre page avec ancre - stocker pour après
        sessionStorage.setItem('scrollToAnchor', hash);
      }
    });

    // Scroll vers ancre après navigation
    const scrollToAnchor = sessionStorage.getItem('scrollToAnchor');
    if (scrollToAnchor) {
      sessionStorage.removeItem('scrollToAnchor');
      setTimeout(() => {
        const target = document.querySelector(scrollToAnchor);
        if (target && (window as any).lenis) {
          (window as any).lenis.scrollTo(target, { duration: 1.2, offset: -100 });
        } else if (target) {
          target.scrollIntoView({ behavior: 'smooth' });
        }
      }, 100);
    }
  }

  initAnchorScroll();
  document.addEventListener('astro:after-swap', initAnchorScroll);
</script>
