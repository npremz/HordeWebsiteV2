---
import Layout from "../layouts/Layout.astro";
import BackgroundCanvas from "../components/ui/BackgroundCanvas.astro";
import HeroSection from "../components/sections/HeroSection.astro";
import MethodSection from "../components/sections/MethodSection.astro";
import ProjectSection from "../components/sections/ProjectSection.astro";
import ServiceSection from "../components/sections/ServiceSection.astro";
import Footer from "../components/Footer.astro";
import { createReader } from "@keystatic/core/reader";
import keystaticConfig from "../../keystatic.config";

const reader = createReader(process.cwd(), keystaticConfig);
const siteSettings = await reader.singletons.siteSettings.read();

const title = siteSettings?.homepageTitle || "Horde";
const description =
  siteSettings?.defaultDescription ||
  "Agence web spécialisée en performance et UX.";
---

<Layout
  title={title}
  description={description}
  siteNameAsPrefix={true}
>
  <BackgroundCanvas triggerDistance={500} topOffset={900} bottomOffset={1400} stopTargetId="method-transition">
  </BackgroundCanvas>

  <HeroSection
    titleLine1="Nous\nconcevons"
    titleLine2="des"
    ctaLabel="Notre methode"
  />

  <div id="page-content">
    <section class="pt-64">
      <MethodSection />
    </section>
  </div>
  <div id="white-section" class="full-width-bg">
    <section id="services-section" class="pt-24 sm:pt-32 lg:pt-96">
      <ServiceSection />
    </section>
  </div>
  <div class="relative">
    <svg
      id="projects-parallax-svg"
      class="absolute top-32 lg:top-64 px-4 sm:px-5 lg:px-9 left-1/2 -translate-x-1/2 -translate-y-full -z-99999 w-full aspect-square will-change-transform"
      viewBox="0 0 260 260"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
    >
      <circle cx="129.852" cy="129.852" r="122.83" stroke="#B1B1B1"></circle>
      <rect x="0.5" y="0.5" width="259" height="259" stroke="#B1B1B1"></rect>
    </svg>

    <section class="pt-48 lg:pt-90">
      <ProjectSection />
    </section>
  </div>

  <script>
    function initProjectsSvgParallax() {
      const svg = document.getElementById('projects-parallax-svg') as HTMLElement;
      if (!svg) return;

      const speed = 0.2;

      function updateSvg() {
        const rect = svg.getBoundingClientRect();
        const viewportHeight = window.innerHeight;

        // Le trigger point est à 80% de la hauteur du viewport
        const triggerPoint = viewportHeight * 0.25;

        // Distance parcourue après le trigger point (positive quand on scroll vers le bas)
        const distancePastTrigger = triggerPoint - rect.top;

        if (distancePastTrigger <= 0) {
          // Pas encore au trigger point
          svg.style.transform = ``;
          return;
        }

        // Calculer le déplacement basé sur la distance après le trigger
        const translateY = -distancePastTrigger * speed;

        svg.style.transform = `translateY(${translateY}px)`;
      }

      let ticking = false;
      function onScroll() {
        if (!ticking) {
          requestAnimationFrame(() => {
            updateSvg();
            ticking = false;
          });
          ticking = true;
        }
      }

      window.addEventListener('scroll', onScroll, { passive: true });
      updateSvg();

      document.addEventListener('astro:before-swap', () => {
        window.removeEventListener('scroll', onScroll);
      }, { once: true });
    }

    initProjectsSvgParallax();
    document.addEventListener('astro:after-swap', initProjectsSvgParallax);
  </script>

  <Footer />
</Layout>
