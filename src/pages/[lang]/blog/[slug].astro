---
import Layout from '../../../layouts/Layout.astro';
import Footer from '../../../components/Footer.astro';
import Wrapped from '../../../components/ui/Wrapped.astro';
import { Image } from 'astro:assets';
import { SUPPORTED_LOCALES, type Locale, useTranslations } from '../../../i18n';
import { getCollection } from 'astro:content';

export const prerender = true;

export async function getStaticPaths() {
	const posts = await getCollection('posts');

	return SUPPORTED_LOCALES.flatMap((lang) =>
		posts
			.filter((post) => !post.data.draft)
			.map((post) => ({
				params: { lang, slug: post.data.slug },
				props: { post, lang },
			}))
	);
}

const { post, lang } = Astro.props as { post: any; lang: Locale };
const t = useTranslations(lang);

// Récupérer auteurs et catégories
const rawAuthors = await getCollection('authors');
const rawCategories = await getCollection('categories');

const authorsMap = new Map(rawAuthors.map((a) => [a.data.slug, a.data]));
const categoriesMap = new Map(rawCategories.map((c) => [c.data.slug, c.data]));

// Données localisées
const title = lang === 'fr' ? post.data.title_fr : post.data.title_en;
const excerpt = lang === 'fr' ? post.data.excerpt_fr : post.data.excerpt_en;
const seoDescription = lang === 'fr' ? post.data.seoDescription_fr : post.data.seoDescription_en;
const featuredImageAlt = lang === 'fr' ? post.data.featuredImageAlt_fr : post.data.featuredImageAlt_en;

// Auteur
const author = authorsMap.get(post.data.author);
const authorName = author?.name || 'Horde';
const authorRole = author ? (lang === 'fr' ? author.role_fr : author.role_en) : '';
const authorBio = author ? (lang === 'fr' ? author.bio_fr : author.bio_en) : '';
const authorAvatar = author?.avatar;

// Catégorie
const category = categoriesMap.get(post.data.category);
const categoryName = category ? (lang === 'fr' ? category.name_fr : category.name_en) : '';

// Tags
const tags = post.data.tags || [];

// Dates
const publishedDate = post.data.publishedDate;
const modifiedDate = post.data.modifiedDate;
const readingTime = post.data.readingTime || 5;

// Contenu - Keystatic stocke le MDX dans des fichiers séparés
const allContents = import.meta.glob('../../../content/posts/*/content_*.mdx', { query: '?raw', import: 'default' });
const contentPath = `../../../content/posts/${post.data.slug}/content_${lang}.mdx`;
let articleContent = '';
if (allContents[contentPath]) {
	articleContent = await allContents[contentPath]() as string;
}

// Extraire les titres H2 pour le sommaire (rendu côté serveur pour SEO)
function extractHeadings(content: string): { id: string; text: string }[] {
	const headingRegex = /^## (.+)$/gm;
	const headings: { id: string; text: string }[] = [];
	let match;
	while ((match = headingRegex.exec(content)) !== null) {
		const text = match[1];
		const id = text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
		headings.push({ id, text });
	}
	return headings;
}

const tableOfContents = extractHeadings(articleContent);

// Articles connexes (même catégorie, excluant l'article actuel)
const rawPosts = await getCollection('posts');
const relatedPosts = rawPosts
	.filter((p) => !p.data.draft && p.data.slug !== post.data.slug && p.data.category === post.data.category)
	.sort((a, b) => new Date(b.data.publishedDate).getTime() - new Date(a.data.publishedDate).getTime())
	.slice(0, 3)
	.map((p) => ({
		slug: p.data.slug,
		title: lang === 'fr' ? p.data.title_fr : p.data.title_en,
		image: p.data.featuredImage,
		imageAlt: lang === 'fr' ? p.data.featuredImageAlt_fr : p.data.featuredImageAlt_en,
		readingTime: p.data.readingTime || 5,
	}));

// Parser le markdown simplifié
function parseMarkdown(content: string): string {
	if (!content) return '';

	let html = content;

	// Blocs de code avec langage
	html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, (_, lang, code) => {
		const escaped = code.trim()
			.replace(/&/g, '&amp;')
			.replace(/</g, '&lt;')
			.replace(/>/g, '&gt;');
		return `<div class="pb-10 sm:pb-16 border-b border-lines"><pre class="bg-bg-light p-4 overflow-x-auto text-[1rem]"><code class="language-${lang || 'text'}">${escaped}</code></pre></div>`;
	});

	// Code inline
	html = html.replace(/`([^`]+)`/g, '<code class="px-1.5 py-0.5">$1</code>');

	// Titres H2 avec id pour TOC
	html = html.replace(/^## (.+)$/gm, (_, title) => {
		const id = title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
		return `<h2 class="text-[2rem] leading-tight max-w-[400px] mt-16 sm:mt-32 mb-10 sm:mb-16 scroll-mt-24" id="${id}">${title}</h2>`;
	});

	// Titres H3
	html = html.replace(/^### (.+)$/gm, '<h3 class="text-[1.5rem] mt-12 mb-10">$1</h3>');

	// Listes à puces
	html = html.replace(/^- (.+)$/gm, '<li class="ml-4">$1</li>');
	html = html.replace(/(<li.*<\/li>\n?)+/g, (match) => {
		// Nettoyer les espaces/retours de ligne en fin de match
		const cleanMatch = match.replace(/\s+$/, '');
		return `<ul class="list-disc list-outside flex flex-col gap-10  py-10 sm:py-16 border-t border-b border-lines mb-6 pl-4">${cleanMatch}</ul>`;
	});

	// Gras et italique
	html = html.replace(/\*\*([^*]+)\*\*/g, '<strong class="font-normal">$1</strong>');
	html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');

	// Liens
	html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" class="underline underline-offset-2 hover:opacity-70 transition-opacity">$1</a>');

	// Paragraphes (lignes non vides qui ne sont pas déjà des éléments HTML ou des lignes blanches)
	html = html.replace(/^(?!<[a-z]|\s*$)(.+)$/gm, '<p class="mb-10 sm:mb-16 leading-relaxed">$1</p>');

	// Nettoyer les <p> vides ou ne contenant que des espaces (partout dans le HTML)
	html = html.replace(/<p[^>]*>\s*<\/p>/g, '');

	// Nettoyer les sauts de ligne multiples
	html = html.replace(/\n{3,}/g, '\n\n');

	return html;
}

// Formater la date
function formatDate(date: Date, locale: string): string {
	return new Intl.DateTimeFormat(locale === 'fr' ? 'fr-FR' : 'en-US', {
		day: 'numeric',
		month: 'long',
		year: 'numeric',
	}).format(new Date(date));
}

// URL de partage
const shareUrl = `${Astro.site}${lang}/blog/${post.data.slug}`;
const siteUrl = Astro.site?.toString() || 'https://hordeagency.com';
const articleUrl = `${siteUrl}${lang}/blog/${post.data.slug}`;
const imageUrl = post.data.featuredImage.src?.startsWith('http')
	? post.data.featuredImage.src
	: `${siteUrl}${post.data.featuredImage.src}`;

// Schema.org JSON-LD
const schemaOrg = {
	"@context": "https://schema.org",
	"@graph": [
		// BlogPosting
		{
			"@type": "BlogPosting",
			"@id": `${articleUrl}#article`,
			"headline": title,
			"description": seoDescription,
			"image": imageUrl,
			"datePublished": publishedDate.toISOString(),
			"dateModified": modifiedDate ? modifiedDate.toISOString() : publishedDate.toISOString(),
			"author": {
				"@type": "Person",
				"name": authorName,
				"jobTitle": authorRole,
				...(author?.social?.twitter && { "sameAs": `https://twitter.com/${author.social.twitter}` }),
			},
			"publisher": {
				"@type": "Organization",
				"name": "Horde",
				"url": siteUrl,
				"logo": {
					"@type": "ImageObject",
					"url": `${siteUrl}images/logo.svg`
				}
			},
			"mainEntityOfPage": {
				"@type": "WebPage",
				"@id": articleUrl
			},
			"articleSection": categoryName,
			"keywords": tags.join(", "),
			"wordCount": articleContent.split(/\s+/).length,
			"timeRequired": `PT${readingTime}M`,
			"inLanguage": lang === 'fr' ? 'fr-FR' : 'en-US'
		},
		// BreadcrumbList
		{
			"@type": "BreadcrumbList",
			"@id": `${articleUrl}#breadcrumb`,
			"itemListElement": [
				{
					"@type": "ListItem",
					"position": 1,
					"name": lang === 'fr' ? 'Accueil' : 'Home',
					"item": `${siteUrl}${lang}`
				},
				{
					"@type": "ListItem",
					"position": 2,
					"name": "Blog",
					"item": `${siteUrl}${lang}/blog`
				},
				{
					"@type": "ListItem",
					"position": 3,
					"name": title,
					"item": articleUrl
				}
			]
		}
	]
};
---

<Layout lang={lang} title={title} description={seoDescription} ogType="article" publishedTime={publishedDate.toISOString()} modifiedTime={modifiedDate?.toISOString()} author={authorName}>
	<!-- Schema.org JSON-LD -->
	<script type="application/ld+json" set:html={JSON.stringify(schemaOrg)} />

	<div class="fixed inset-0 bg-bg -z-10" aria-hidden="true"></div>
	<article id="page-content" class="relative z-10 bg-bg">
		<!-- Header Article -->
		<header class="pt-50 sm:pt-78 mb-10 sm:mb-16">
			<!-- Catégorie + Temps de lecture -->
			<div class="flex items-center gap-3 section-label mb-8 leading-none">
				<a href={`/${lang}/blog`} class="hover:text-black transition-colors">{categoryName}</a>
				<span>—</span>
				<span>{readingTime} {t.blogPage.minRead}</span>
			</div>

			<!-- Titre -->
			<h1 class="font-display text-[2rem] md:text-[3rem] lg:text-[4rem] leading-[1.1] uppercase mb-8 sm:mb-16 max-w-[520px] md:max-w-[720px]">
				{title}
			</h1>

			<!-- Meta: Auteur + Date -->
			<div class="flex flex-col p-5 sm:p-8 border border-lines sm:flex-row sm:justify-between sm:items-end gap-4 sm:gap-8 mb-10 sm:mb-24">
				<!-- Auteur -->
				<div class="flex items-center gap-4">
					{authorAvatar && (
						<Image
							src={authorAvatar}
							alt={authorName}
							class="h-full aspect-square object-cover"
							widths={[72, 100]}
							height={100}
						/>
					)}
					<div>
						<p class="text-[1.375rem]">{authorName}</p>
						{authorRole && <p class="section-label max-w-[170px]">{authorRole}</p>}
					</div>
				</div>
				<!-- Dates -->
				<div class="section-label sm:max-w-32">
					<p>
						<span >{t.blogPage.publishedOn}</span>{" "}
						<time datetime={publishedDate.toISOString()}>{formatDate(publishedDate, lang)}</time>
					</p>
					{modifiedDate && (
						<p >
							<span >{t.blogPage.updatedOn}</span>{" "}
							<time datetime={modifiedDate.toISOString()}>{formatDate(modifiedDate, lang)}</time>
						</p>
					)}
				</div>
			</div>
			<div class="flex justify-end">
				<Wrapped class:list={"font-mono leading-none text-[1rem] align-"}>↓</Wrapped>
			</div>
		</header>

		<!-- Image principale -->
		<figure class="py-10 sm:py-24 border-t border-b border-lines mb-10 sm:mb-24">
			<Image
				src={post.data.featuredImage}
				alt={featuredImageAlt}
				class="w-full h-auto object-cover"
				widths={[400, 800, 1200, 1600]}
				sizes="100vw"
				loading="eager"
				fetchpriority="high"
				decoding="async"
				format="webp"
				quality={85}
			/>
		</figure>

		<!-- Layout 2 colonnes: Contenu + Sidebar -->
		<div>
			<!-- Contenu principal -->
			<div class="lg:flex-1 max-w-3xl mx-auto">
				<!-- Extrait / Chapô -->
				<p class="text-[1.625rem] sm:text-[2rem] md:text-[2.5rem] leading-relaxed pb-10 sm:pb-24 border-b border-lines font-medium">
					{excerpt}
				</p>

				<!-- Sommaire (rendu côté serveur pour SEO) -->
				{tableOfContents.length > 0 && (
					<nav class="mt-10 sm:mt-24 pb-10" aria-label={lang === 'fr' ? 'Sommaire' : 'Table of contents'}>
						<h2 class="section-label mb-8">{lang === 'fr' ? 'Sommaire' : 'Table of contents'}</h2>
						<ol class="flex flex-col gap-2.5">
							{tableOfContents.map((heading, index) => (
								<li class="pb-2.5 border-b border-lines">
									<a
										href={`#${heading.id}`}
										class="flex items-baseline gap-3 hover:text-black/60 transition-colors"
									>
										<span class="section-label">{String(index + 1).padStart(2, '0')}</span>
										<span>{heading.text}</span>
									</a>
								</li>
							))}
						</ol>
					</nav>
				)}

				<!-- Contenu de l'article -->
				<div class="prose prose-lg text-[1.375rem] max-w-none mb-16" set:html={parseMarkdown(articleContent)} />
				{!articleContent && (
					<p class="text-black/60 italic">Contenu de l'article à venir...</p>
				)}

			</div>
			<div class="max-w-3xl mx-auto lg:max-w-none">
				<!-- Tags + Partage (2 colonnes sur lg) -->
				<div class="lg:flex lg:gap-16 pt-10 sm:pt-16 lg:pt-24 sm:mt-24 border-t border-lines mb-10 sm:mb-16 lg:pb-24 lg:mb-0">
					<!-- Tags -->
					{tags.length > 0 && (
						<div class="mb-10 lg:mb-0 lg:flex-1">
							<h2 class="section-label mb-4">{t.blogPage.tags}</h2>
							<div class="flex flex-wrap gap-2 md:gap-4">
								{tags.map((tag: string) => (
									<span class="px-5 py-3 border border-lines text-[0.875rem] font-mono uppercase">
										{tag}
									</span>
								))}
							</div>
						</div>
					)}

					<!-- Partage -->
					<div class="lg:flex-1">
						<h2 class="section-label mb-4">{t.blogPage.shareArticle}</h2>
						<div class="flex flex-wrap gap-2 md:gap-4">
							<a
								href={`https://twitter.com/intent/tweet?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(title)}`}
								target="_blank"
								rel="noopener noreferrer"
								class="px-5 py-3 border border-lines font-mono text-[0.875rem] uppercase hover:bg-black hover:text-white transition-colors"
							>
								Twitter
							</a>
							<a
								href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(shareUrl)}`}
								target="_blank"
								rel="noopener noreferrer"
								class="px-5 py-3 border border-lines font-mono text-[0.875rem] uppercase hover:bg-black hover:text-white transition-colors"
							>
								LinkedIn
							</a>
							<button
								type="button"
								class="copy-link px-5 py-3 border border-lines font-mono text-[0.875rem] uppercase hover:bg-black hover:text-white transition-colors"
								data-url={shareUrl}
							>
								{lang === 'fr' ? 'Copier le lien' : 'Copy link'}
							</button>
						</div>
					</div>
				</div>

				<!-- Bio Auteur -->
				{author && (
					<h2 class="section-label mb-8">{t.blogPage.about}</h2>
					<div class="mb-16 p-6 md:p-8 border border-lines">
						{/* Mobile: photo + nom/rôle côte à côte, description en dessous */}
						<div class="flex gap-4 mb-5 md:hidden">
							{authorAvatar && (
								<Image
									src={authorAvatar}
									alt={authorName}
									class="w-20 h-20 aspect-square object-cover shrink-0"
									width={80}
									height={80}
								/>
							)}
							<div class="flex flex-col">
								<p class="text-[1.375rem]">{authorName}</p>
								{authorRole && <p class="section-label">{authorRole}</p>}
							</div>
						</div>
						<div class="md:hidden">
							{authorBio && <p class="leading-relaxed">{authorBio}</p>}
							{author.social && (
								<div class="flex gap-4 mt-8">
									{author.social.twitter && (
										<a href={`https://twitter.com/${author.social.twitter}`} target="_blank" rel="noopener noreferrer" class="text-black/60 hover:text-black transition-colors">
											Twitter
										</a>
									)}
									{author.social.linkedin && (
										<a href={author.social.linkedin} target="_blank" rel="noopener noreferrer" class="text-black/60 hover:text-black transition-colors">
											LinkedIn
										</a>
									)}
									{author.social.github && (
										<a href={`https://github.com/${author.social.github}`} target="_blank" rel="noopener noreferrer" class="text-black/60 hover:text-black transition-colors">
											GitHub
										</a>
									)}
								</div>
							)}
						</div>
						{/* Desktop (md+): photo à gauche, nom/rôle inline + description à droite */}
						<div class="hidden md:flex md:gap-8">
							{authorAvatar && (
								<div class="shrink-0">
									<Image
										src={authorAvatar}
										alt={authorName}
										class="w-auto h-full aspect-square object-cover"
										width={160}
										height={160}
									/>
								</div>
							)}
							<div class="flex-1">
								<div class="flex items-baseline gap-4 mb-4">
									<p class="text-[1.375rem]">{authorName}</p>
									{authorRole && <p class="section-label">{authorRole}</p>}
								</div>
								<div class="lg:flex lg:justify-between lg:gap-8">
									{authorBio && <p class="leading-relaxed lg:max-w-135">{authorBio}</p>}
									{/* Liens réseaux - en ligne avec bio sur lg+ */}
									{author.social && (
										<div class="flex lg:flex-col gap-4 mt-8 lg:mt-0 shrink-0">
											{author.social.twitter && (
												<a href={`https://twitter.com/${author.social.twitter}`} target="_blank" rel="noopener noreferrer" class="text-black/60 hover:text-black transition-colors">
													Twitter
												</a>
											)}
											{author.social.linkedin && (
												<a href={author.social.linkedin} target="_blank" rel="noopener noreferrer" class="text-black/60 hover:text-black transition-colors">
													LinkedIn
												</a>
											)}
											{author.social.github && (
												<a href={`https://github.com/${author.social.github}`} target="_blank" rel="noopener noreferrer" class="text-black/60 hover:text-black transition-colors">
													GitHub
												</a>
											)}
										</div>
									)}
								</div>
							</div>
						</div>
					</div>
				)}
				</div>
		</div>

		<!-- Articles connexes -->
		{relatedPosts.length > 0 && (
			<section class="mt-16 md:mt-24 pt-10 border-t border-lines">
				<h2 class="font-display text-[1.5rem] md:text-[2rem] uppercase mb-10">{t.blogPage.relatedArticles}</h2>
				<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
					{relatedPosts.map((related, index) => (
						<a href={`/${lang}/blog/${related.slug}`} class="group">
							<div class="overflow-hidden mb-4 aspect-square">
								<Image
									src={related.image}
									alt={related.imageAlt}
									class="w-full h-full object-cover transition-transform duration-400 group-hover:scale-105"
									widths={[250, 400]}
									sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw"
									loading="lazy"
									decoding="async"
									format="webp"
									quality={75}
								/>
							</div>
							<p class="text-[0.75rem] font-mono uppercase text-black/60 mb-2">{related.readingTime} {t.blogPage.minRead}</p>
							<h3 class="text-[1.125rem] leading-tight">{related.title}</h3>
						</a>
					))}
				</div>
			</section>
		)}

		<!-- Bouton retour -->
		<nav class="mt-16 mb-10 flex justify-end max-w-3xl mx-auto lg:max-w-none">
			<a
				href={`/${lang}/blog`}
				class="group relative overflow-hidden font-mono text-[1rem] leading-none uppercase py-6 px-5 flex justify-center w-full md:w-fit border border-lines-dark bg-black text-white transition-colors duration-300 ease-in-out cursor-pointer"
			>
				<span class="absolute inset-0 bg-bg-light translate-x-[calc(-100%-1px)] group-hover:translate-x-0 transition-transform duration-400 ease-[cubic-bezier(0.25,0.46,0.45,0.94)]"></span>
				<span class="relative z-10 text-white group-hover:text-black transition-colors duration-300">
					{t.blogPage.allArticles}
				</span>
			</a>
		</nav>
	</article>

	<Footer lang={lang} hideOverflow={false} />
</Layout>

<style>
	/* Prose styles */
	.prose h2 {
		scroll-margin-top: 6rem;
	}

	.prose a {
		text-decoration: underline;
		text-underline-offset: 3px;
		transition: color 0.2s;
	}

	.prose a:hover {
		color: var(--color-black);
		opacity: 0.7;
	}

	.prose blockquote {
		border-left: 2px solid var(--color-lines);
		padding-left: 1.5rem;
		font-style: italic;
		color: rgba(0, 0, 0, 0.7);
	}

	.prose code {
		background: var(--color-lines);
		padding: 0.125rem 0.375rem;
		border-radius: 0.25rem;
		font-size: 0.875em;
	}

	.prose pre {
		background: var(--color-black);
		color: var(--color-bg-light);
		padding: 1.5rem;
		overflow-x: auto;
		margin: 1.5rem 0;
	}

	.prose pre code {
		background: none;
		padding: 0;
	}

	.prose li > p:last-child {
		margin-bottom: 0;
	}

	.prose img {
		width: 100%;
		height: auto;
		margin: 2rem 0;
	}

	/* TOC active state */
	#toc a {
		display: block;
		padding: 0.5rem 0;
		color: rgba(0, 0, 0, 0.6);
		border-left: 2px solid transparent;
		padding-left: 1rem;
		margin-left: -1rem;
		transition: all 0.2s;
	}

	#toc a:hover,
	#toc a.active {
		color: var(--color-black);
		border-left-color: var(--color-black);
	}
</style>

<script>
	function initTOC() {
		const toc = document.getElementById('toc');
		const headings = document.querySelectorAll('.prose h2');

		if (!toc || headings.length === 0) return;

		// Générer la TOC
		toc.innerHTML = '';
		headings.forEach((heading) => {
			const li = document.createElement('li');
			const a = document.createElement('a');
			a.href = `#${heading.id}`;
			a.textContent = heading.textContent;
			li.appendChild(a);
			toc.appendChild(li);
		});

		// Highlight active heading on scroll
		const observer = new IntersectionObserver(
			(entries) => {
				entries.forEach((entry) => {
					const id = entry.target.id;
					const tocLink = toc.querySelector(`a[href="#${id}"]`);
					if (tocLink) {
						if (entry.isIntersecting) {
							toc.querySelectorAll('a').forEach((a) => a.classList.remove('active'));
							tocLink.classList.add('active');
						}
					}
				});
			},
			{ rootMargin: '-100px 0px -80% 0px' }
		);

		headings.forEach((heading) => observer.observe(heading));
	}

	function initCopyLink() {
		const copyButtons = document.querySelectorAll('.copy-link');
		copyButtons.forEach((btn) => {
			btn.addEventListener('click', async () => {
				const url = (btn as HTMLElement).dataset.url;
				if (url) {
					await navigator.clipboard.writeText(url);
					const originalText = btn.textContent;
					btn.textContent = '✓';
					setTimeout(() => {
						btn.textContent = originalText;
					}, 2000);
				}
			});
		});
	}

	initTOC();
	initCopyLink();
	document.addEventListener('astro:after-swap', () => {
		initTOC();
		initCopyLink();
	});
</script>
