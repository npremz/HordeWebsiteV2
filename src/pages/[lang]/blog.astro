---
import Layout from '../../layouts/Layout.astro';
import Footer from '../../components/Footer.astro';
import Wrapped from '../../components/ui/Wrapped.astro';
import { Image } from 'astro:assets';
import { SUPPORTED_LOCALES, type Locale, useTranslations } from '../../i18n';
import { getCollection } from 'astro:content';

export const prerender = true;

export function getStaticPaths() {
  return SUPPORTED_LOCALES.map((lang) => ({
    params: { lang },
  }));
}

const { lang } = Astro.params as { lang: Locale };
const t = useTranslations(lang);

// Récupérer les articles, auteurs et catégories
const rawPosts = await getCollection('posts');
const rawAuthors = await getCollection('authors');
const rawCategories = await getCollection('categories');

// Créer des maps pour les lookups
const authorsMap = new Map(rawAuthors.map((a) => [a.data.slug, a.data]));
const categoriesMap = new Map(rawCategories.map((c) => [c.data.slug, c.data]));

// Transformer et trier les articles (plus récents en premier, exclure brouillons)
const posts = rawPosts
  .filter((post) => !post.data.draft)
  .sort((a, b) => new Date(b.data.publishedDate).getTime() - new Date(a.data.publishedDate).getTime())
  .map((post) => {
    const author = authorsMap.get(post.data.author);
    const category = categoriesMap.get(post.data.category);
    // Utiliser thumbnailImage si disponible, sinon featuredImage
    const gridImage = post.data.thumbnailImage || post.data.featuredImage;
    const gridImageAlt = post.data.thumbnailImage
      ? (lang === 'fr' ? post.data.thumbnailImageAlt_fr : post.data.thumbnailImageAlt_en) || (lang === 'fr' ? post.data.featuredImageAlt_fr : post.data.featuredImageAlt_en)
      : (lang === 'fr' ? post.data.featuredImageAlt_fr : post.data.featuredImageAlt_en);
    return {
      slug: post.data.slug,
      title: lang === 'fr' ? post.data.title_fr : post.data.title_en,
      excerpt: lang === 'fr' ? post.data.excerpt_fr : post.data.excerpt_en,
      image: gridImage,
      imageAlt: gridImageAlt,
      publishedDate: post.data.publishedDate,
      readingTime: post.data.readingTime || 5,
      featured: post.data.featured,
      authorName: author?.name || 'Horde',
      categoryName: category ? (lang === 'fr' ? category.name_fr : category.name_en) : '',
      categorySlug: post.data.category,
      tags: post.data.tags || [],
    };
  });

const articleCount = posts.length;

// Formater la date en "DD month YY"
function formatDate(date: Date, locale: string): string {
  return new Intl.DateTimeFormat(locale === 'fr' ? 'fr-FR' : 'en-US', {
    day: '2-digit',
    month: 'short',
    year: '2-digit',
  }).format(date);
}
---

<Layout lang={lang} title={t.blogPage.title} description={t.blogPage.description}>
	<div class="fixed inset-0 bg-bg-light -z-10" aria-hidden="true"></div>
	<div id="page-content" class="relative z-10">
		<div class="pt-52 sm:pt-80 xl:pt-96">
			<!-- Breadcrumbs -->
			<nav aria-label="Breadcrumb" class="mb-8">
				<ol class="flex items-center gap-2 section-label flex-wrap">
					<li><a href={`/${lang}`} class="hover:text-black transition-colors">{lang === 'fr' ? 'Accueil' : 'Home'}</a></li>
					<li><span class="mx-1">/</span></li>
					<li aria-current="page" class="text-black">Blog</li>
				</ol>
			</nav>

			<div class="flex flex-col leading-none">
				<span class="section-label mb-8">{lang === 'fr' ? 'Un petit café avec la lecture ?' : 'A coffee with your reading?'}</span>
				<h1 class="leading-none font-display text-[2rem] md:text-[2.5rem] lg:text-[3rem] uppercase" set:html={t.blogPage.heading.replace(/\n/g, '<br>')} />
			</div>
		</div>

		<!-- Grille des articles -->
		<ol id="posts-grid" class="mt-10 sm:mt-32 grid grid-cols-1 sm:grid-cols-2 slg:grid-cols-[320px_1fr_320px] gap-10 sm:gap-5 md:gap-16 slg:gap-8 sm:gap-y-24 text-2xl sm:text-[2rem] lg:text-[2.5rem]">
			{posts.map((post, index) => {
				// Mode 2 colonnes (sm)
				const sm = index % 2 === 0 ? "sm:justify-self-start" : "sm:justify-self-end";
				// Mode 3 colonnes (slg) : col1=start, col3=end, col2=alterne end/start
				const col = index % 3;
				const slg = col === 0 ? "slg:justify-self-start"
					: col === 2 ? "slg:justify-self-end"
					: Math.floor(index / 3) % 2 === 0 ? "slg:justify-self-end" : "slg:justify-self-start";
				return (
				<li class:list={["post-item-grid", sm, slg]} data-image={post.image.src || ""}>
					<a href={`/${lang}/blog/${post.slug}`}>
						<div class="overflow-hidden mb-8 sm:max-w-70! slg:max-w-80! aspect-square">
							<Image
								src={post.image}
								alt={post.imageAlt}
								class="w-full h-full object-cover post-img"
								widths={[250, 400, 600]}
								sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw"
								loading={index === 0 ? "eager" : "lazy"}
								fetchpriority={index === 0 ? "high" : "auto"}
								decoding="async"
								format="webp"
								quality={75}
							/>
						</div>
						<div class="flex flex-col gap-3 sm:max-w-70 slg:max-w-80">
							<h2 class="text-[1.25rem] leading-normal mb-4">{post.title}</h2>
							<div class="section-label flex justify-between">
								<span>{post.categoryName} - {formatDate(new Date(post.publishedDate), lang)}</span>
								<Wrapped>→</Wrapped>
							</div>
						</div>
					</a>
				</li>
			);
			})}
		</ol>

	</div>

	<Footer lang={lang} hideOverflow={false} />
</Layout>

<style>
	.post-item-grid {
		position: relative;
	}

	.post-item-grid .post-img {
		transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
	}

	@media (hover: hover) {
		.post-item-grid:hover .post-img {
			transform: scale(1.05);
		}
	}

</style>
