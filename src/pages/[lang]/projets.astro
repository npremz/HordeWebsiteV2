---
import Layout from '../../layouts/Layout.astro';
import Footer from '../../components/Footer.astro';
import Wrapped from '../../components/ui/Wrapped.astro';
import { Image } from 'astro:assets';
import { SUPPORTED_LOCALES, type Locale, useTranslations } from '../../i18n';

// Import des images pour optimisation Astro
import belgaImg from '../../assets/images/projects/belga.jpg';
import merlyImg from '../../assets/images/projects/merly.jpg';
import eputchImg from '../../assets/images/projects/eputch.jpg';

export const prerender = true;

export function getStaticPaths() {
  return SUPPORTED_LOCALES.map((lang) => ({
    params: { lang },
  }));
}

const { lang } = Astro.params as { lang: Locale };
const t = useTranslations(lang);

interface Project {
	name: string;
	href: string | null;
	image: ImageMetadata | null;
	description: string | null;
	inProgress: boolean;
}

const projects: Project[] = [
	{
		name: "Café Belga",
		href: "https://belga.hordagency.com",
		image: belgaImg,
		description: "Horde Agence | Étude de cas pour le Café Belga place Flagey",
		inProgress: false,
	},
	{
		name: "Merly",
		href: "https://merly.hordagency.com",
		image: merlyImg,
		description: "Horde Agence | Merly, Site vitrine pour un service d'investissement",
		inProgress: false,
	},
	{
		name: "E-Putch",
		href: null,
		image: eputchImg,
		description: null,
		inProgress: true,
	},
];

const projectCount = projects.length;
---

<Layout lang={lang} title={t.projectsPage.title} description={t.projectsPage.description}>
	<!-- Fond fixe derrière tout le contenu -->
	<div class="fixed inset-0 bg-bg-light -z-10" aria-hidden="true"></div>
	<div id="page-content">
		<div class="pt-80 xl:pt-96">
			<div class="flex flex-col sm:flex-row sm:justify-between font-display gap-5 leading-none">
				<h1 class="leading-none text-[2rem] md:text-[2.5rem] lg:text-[3rem] uppercase" set:html={t.projectsPage.heading.replace(/\n/g, '<br>')} />
				<span class="hidden sm:block self-stretch w-px bg-lines"></span>
				<div class="flex flex-col items-end gap-4 sm:gap-0 sm:justify-between">
					<p>{t.projectsPage.projectCount}</p>
					<span class="text-[2rem] md:text-[2.5rem] lg:text-[3rem] leading-none">({String(projectCount).padStart(2, "0")})</span>
				</div>
			</div>
		</div>

		<!-- Switch vue grille/liste -->
		<div class="mt-10 sm:mt-16 flex items-center md:justify-end">
			<button
				id="view-grid"
				type="button"
				class="view-switch active text-[1rem] font-mono uppercase flex flex-1 md:flex-none items-center justify-center gap-2 px-5 py-6 leading-none border border-lines transition-colors duration-300"
				aria-pressed="true"
			>
				{t.projectsPage.viewGrid}
			</button>
			<button
				id="view-list"
				type="button"
				class="view-switch text-[1rem] font-mono uppercase flex flex-1 md:flex-none items-center justify-center gap-2 px-5 py-6 leading-none border border-lines transition-colors duration-300"
				aria-pressed="false"
			>
				{t.projectsPage.viewList}
			</button>
		</div>

		<!-- Vue Grille -->
		<ol id="projects-grid" class="mt-10 sm:mt-16 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-10 sm:gap-5 md:gap-16 lg:gap-24 sm:gap-y-24 text-2xl sm:text-[2rem] lg:text-[2.5rem]">
			{projects.flatMap((project, index) => [
				<li class="project-item-grid" data-image={project.image?.src || ""} data-in-progress={project.inProgress}>
					{project.href ? (
						<a
							href={project.href}
							target="_blank"
						>
							{project.image && (
								<div class="overflow-hidden mb-8 aspect-square">
									<Image
										src={project.image}
										alt={project.description || project.name}
										class="w-full h-full object-cover project-img"
										widths={[250, 400, 600]}
										sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw"
										loading={index === 0 ? "eager" : "lazy"}
										fetchpriority={index === 0 ? "high" : "auto"}
										decoding="async"
										format="webp"
										quality={75}
									/>
								</div>
							)}
							<div class="flex gap-2 items-end text-[2rem]">
								<h2>{project.name}</h2>
							</div>
						</a>
					) : (
						<div>
							{project.image && (
								<div class="overflow-hidden mb-8 aspect-square">
									<Image
										src={project.image}
										alt={project.description || project.name}
										class="w-full h-full object-cover project-img"
										widths={[250, 400, 600]}
										sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw"
										loading={index === 0 ? "eager" : "lazy"}
										fetchpriority={index === 0 ? "high" : "auto"}
										decoding="async"
										format="webp"
										quality={75}
									/>
								</div>
							)}
							<div class="flex gap-2 items-end">
								<h2 class="text-[2rem]">{project.name}</h2>
								<span class="section-label -translate-y-2">{t.projects.inProgress}</span>
							</div>
						</div>
					)}
				</li>,
				(index + 1) % 2 === 0 && index < projects.length - 1 && (
					<li class="hidden sm:block" aria-hidden="true"></li>
				)
			])}
		</ol>

		<!-- Image flottante qui suit la souris (desktop only, vue liste) -->
		<div
			id="project-hover-image"
			class="hidden md:block pointer-events-none fixed z-50 overflow-visible"
			style="transform: translate(-50%, -50%) scale(0); will-change: transform;"
		>
			<div class="w-[315px] h-[315px] overflow-hidden">
				<img
					id="project-hover-img"
					src=""
					alt=""
					class="w-full h-full object-cover"
				/>
				<div
					id="project-hover-placeholder"
					class="hidden w-full h-full bg-bg-light border border-lines flex items-center justify-center"
				>
					<span class="section-label">{t.projects.inProgress}</span>
				</div>
			</div>
		</div>

		<!-- Vue Liste -->
		<ol id="projects-list" class="hidden mt-10 sm:mt-16 text-2xl sm:text-[2rem] lg:text-[2.5rem]">
			{projects.map((project, index) => (
				<li
					class="project-item-list"
					data-image={project.image?.src || ""}
					data-in-progress={project.inProgress}
				>
					{project.href ? (
						<a
							href={project.href}
							target="_blank"
							class:list={[
								"project-link flex justify-between py-5 xl:py-8 px-8 lg:px-9",
								index === 0 ? "border border-lines" : "border-b border-x border-lines",
							]}
						>
							<p>{project.name}</p>
							<Wrapped class="text-[1rem] font-mono">→</Wrapped>
						</a>
					) : (
						<div
							class:list={[
								"project-link flex justify-between py-5 xl:py-8 px-8 lg:px-9",
								index === 0 ? "border border-lines" : "border-b border-x border-lines",
							]}
						>
							<p>
								{project.name}{" "}
								<span class="section-label">{t.projects.inProgress}</span>
							</p>
							<Wrapped class="text-[1rem] font-mono">→</Wrapped>
						</div>
					)}
				</li>
			))}
		</ol>
	</div>

	<Footer lang={lang} hideOverflow={false} />
</Layout>

<style>
	.project-item-grid {
		position: relative;
	}

	.project-item-grid[data-in-progress="true"] .project-img {
		filter: grayscale(100%);
		opacity: 0.7;
	}

	.project-item-grid .project-img {
		transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
	}

	@media (hover: hover) {
		.project-item-grid:not([data-in-progress="true"]):hover .project-img {
			transform: scale(1.05);
		}
	}

	.project-item-list {
		position: relative;
	}

	.project-link {
		position: relative;
		isolation: isolate;
		transition: color 0.3s ease-out;
	}

	.project-link::before {
		content: "";
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background-color: var(--color-black);
		z-index: -1;
		transform: scaleX(0);
		transform-origin: left center;
		transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
	}

	@media (hover: hover) {
		.project-link:hover {
			color: var(--color-bg-light);
		}

		.project-link:hover::before {
			transform: scaleX(1);
		}

		.project-link :global(.wrapped) {
			transition: color 0.3s ease-out 0.2s;
		}

		.project-link:hover :global(.wrapped) {
			color: var(--color-bg-light) !important;
		}
	}

	/* Switch buttons */
	.view-switch {
		cursor: pointer;
		background: transparent;
	}

	.view-switch.active {
		background: var(--color-black);
		color: var(--color-bg-light);
	}

	@media (hover: hover) {
		.view-switch:not(.active):hover {
			background: var(--color-lines);
		}
	}
</style>

<script>
	function initViewSwitch() {
		const gridBtn = document.getElementById('view-grid');
		const listBtn = document.getElementById('view-list');
		const gridView = document.getElementById('projects-grid');
		const listView = document.getElementById('projects-list');

		if (!gridBtn || !listBtn || !gridView || !listView) return;

		function showGrid() {
			gridBtn.classList.add('active');
			gridBtn.setAttribute('aria-pressed', 'true');
			listBtn.classList.remove('active');
			listBtn.setAttribute('aria-pressed', 'false');
			gridView.classList.remove('hidden');
			listView.classList.add('hidden');
		}

		function showList() {
			listBtn.classList.add('active');
			listBtn.setAttribute('aria-pressed', 'true');
			gridBtn.classList.remove('active');
			gridBtn.setAttribute('aria-pressed', 'false');
			listView.classList.remove('hidden');
			gridView.classList.add('hidden');
		}

		gridBtn.addEventListener('click', showGrid);
		listBtn.addEventListener('click', showList);
	}

	initViewSwitch();
	document.addEventListener('astro:after-swap', initViewSwitch);

	function initProjectHoverImage() {
		// Désactiver sur mobile/touch
		const isMobile =
			window.matchMedia("(max-width: 768px)").matches ||
			"ontouchstart" in window;
		if (isMobile || !window.matchMedia("(hover: hover)").matches) return;

		const container = document.getElementById("project-hover-image");
		const img = document.getElementById("project-hover-img") as HTMLImageElement;
		const placeholder = document.getElementById("project-hover-placeholder");
		const projectItems = document.querySelectorAll(".project-item-list");

		if (!container || !img || !placeholder) return;

		let mouseX = 0;
		let mouseY = 0;
		let currentX = 0;
		let currentY = 0;
		let velocityX = 0;
		let currentRotation = 0;
		let targetRotation = 0;
		let currentScale = 0;
		let targetScale = 0;
		let isHovering = false;
		let animationId: number | null = null;

		function animate() {
			const posEase = 0.1;
			const scaleEase = 0.08;
			const rotEase = 0.06;

			// Position
			const prevX = currentX;
			currentX += (mouseX - currentX) * posEase;
			currentY += (mouseY - currentY) * posEase;

			// Vélocité pour l'inertie
			velocityX = currentX - prevX;

			// Inertie : rotation basée sur la vélocité (max ±12deg)
			const inertiaRotation = Math.max(-12, Math.min(12, velocityX * 2.5));
			targetRotation = isHovering ? inertiaRotation : 0;

			// Scale
			currentScale += (targetScale - currentScale) * scaleEase;

			// Force scale to 0 when very small and target is 0
			if (targetScale === 0 && currentScale < 0.01) {
				currentScale = 0;
			}

			// Rotation avec inertie
			currentRotation += (targetRotation - currentRotation) * rotEase;

			container.style.left = `${currentX}px`;
			container.style.top = `${currentY}px`;
			container.style.transform = `translate(-50%, -50%) scale(${currentScale}) rotate(${currentRotation}deg)`;
			container.style.opacity = targetScale === 0 && currentScale < 0.01 ? "0" : "1";

			const isAnimating =
				Math.abs(currentX - mouseX) > 0.1 ||
				Math.abs(currentY - mouseY) > 0.1 ||
				Math.abs(currentScale - targetScale) > 0.01 ||
				Math.abs(currentRotation - targetRotation) > 0.1;

			if (isAnimating) {
				animationId = requestAnimationFrame(animate);
			} else {
				animationId = null;
			}
		}

		function startAnimation() {
			if (!animationId) {
				animationId = requestAnimationFrame(animate);
			}
		}

		let currentElement: HTMLElement | null = null;

		function showImage(element: HTMLElement) {
			const imageSrc = element.dataset.image;
			const inProgress = element.dataset.inProgress === "true";

			if (inProgress || !imageSrc) {
				img.classList.add("hidden");
				placeholder.classList.remove("hidden");
			} else {
				img.src = imageSrc;
				img.classList.remove("hidden");
				placeholder.classList.add("hidden");
			}
		}

		projectItems.forEach((item) => {
			const element = item as HTMLElement;

			element.addEventListener("mouseenter", () => {
				isHovering = true;

				// Si on change d'élément, reset l'animation
				if (currentElement !== element) {
					currentX = mouseX;
					currentY = mouseY;
					currentScale = 0;
					currentRotation = 0;
				}

				currentElement = element;
				showImage(element);
				targetScale = 1;
				startAnimation();
			});

			element.addEventListener("mouseleave", () => {
				isHovering = false;
				currentElement = null;
				targetScale = 0;
				startAnimation();
			});

			element.addEventListener("mousemove", (e) => {
				mouseX = e.clientX;
				mouseY = e.clientY;
				startAnimation();
			});
		});

		// Cleanup
		document.addEventListener(
			"astro:before-swap",
			() => {
				if (animationId) {
					cancelAnimationFrame(animationId);
				}
			},
			{ once: true },
		);
	}

	initProjectHoverImage();
	document.addEventListener("astro:after-swap", initProjectHoverImage);
</script>
