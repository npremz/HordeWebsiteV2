---
interface Props {
  class?: string;
}

const { class: className = '' } = Astro.props;
---

<div id="physics-container" class:list={['physics-grid w-full aspect-square md:aspect-2/1 xl:aspect-3/1 xl:w-[calc(100vw-8rem)] xl:left-1/2 xl:-translate-x-1/2 relative overflow-hidden', className]}>
  <div id="logo-letters" class="absolute inset-0" aria-hidden="true" role="presentation">
    <svg class="physics-letter" width="134" height="66" viewBox="0 0 134 66" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0L133.486 0V65.9931L0 65.9931L0 0Z" fill="#222121"/>
    </svg>
    <svg class="physics-letter" width="132" height="134" viewBox="0 0 132 134" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M131.986 0V66.743L65.9931 66.743L65.9931 133.486H0L0 0L131.986 0Z" fill="#222121"/>
    </svg>
    <svg class="physics-letter" width="66" height="66" viewBox="0 0 66 66" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0H65.9931V65.9931H0V0Z" fill="#222121"/>
    </svg>
    <svg class="physics-letter" width="200" height="66" viewBox="0 0 200 66" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0L199.479 0V65.9931L0 65.9931L0 0Z" fill="#222121"/>
    </svg>
    <svg class="physics-letter" width="134" height="66" viewBox="0 0 134 66" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0L133.486 0V65.9931L0 65.9931L0 0Z" fill="#222121"/>
    </svg>
    <svg class="physics-letter" width="132" height="134" viewBox="0 0 132 134" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M131.986 0V66.743L65.9931 66.743L65.9931 133.486H0L0 0L131.986 0Z" fill="#222121"/>
    </svg>
    <svg class="physics-letter" width="66" height="66" viewBox="0 0 66 66" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0H65.9931V65.9931H0V0Z" fill="#222121"/>
    </svg>
    <svg class="physics-letter" width="200" height="66" viewBox="0 0 200 66" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0L199.479 0V65.9931L0 65.9931L0 0Z" fill="#222121"/>
    </svg>
    <svg class="physics-letter" width="134" height="66" viewBox="0 0 134 66" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0L133.486 0V65.9931L0 65.9931L0 0Z" fill="#222121"/>
    </svg>
    <svg class="physics-letter" width="132" height="134" viewBox="0 0 132 134" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M131.986 0V66.743L65.9931 66.743L65.9931 133.486H0L0 0L131.986 0Z" fill="#222121"/>
    </svg>
    <svg class="physics-letter" width="66" height="66" viewBox="0 0 66 66" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0H65.9931V65.9931H0V0Z" fill="#222121"/>
    </svg>
    <svg class="physics-letter" width="200" height="66" viewBox="0 0 200 66" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0L199.479 0V65.9931L0 65.9931L0 0Z" fill="#222121"/>
    </svg>
    <svg class="physics-letter" width="134" height="66" viewBox="0 0 134 66" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0L133.486 0V65.9931L0 65.9931L0 0Z" fill="#222121"/>
    </svg>
    <svg class="physics-letter" width="132" height="134" viewBox="0 0 132 134" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M131.986 0V66.743L65.9931 66.743L65.9931 133.486H0L0 0L131.986 0Z" fill="#222121"/>
    </svg>
    <svg class="physics-letter" width="66" height="66" viewBox="0 0 66 66" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0H65.9931V65.9931H0V0Z" fill="#222121"/>
    </svg>
    <svg class="physics-letter" width="200" height="66" viewBox="0 0 200 66" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0L199.479 0V65.9931L0 65.9931L0 0Z" fill="#222121"/>
    </svg>
        <svg class="physics-letter" width="134" height="66" viewBox="0 0 134 66" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0L133.486 0V65.9931L0 65.9931L0 0Z" fill="#222121"/>
    </svg>
    <svg class="physics-letter" width="132" height="134" viewBox="0 0 132 134" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M131.986 0V66.743L65.9931 66.743L65.9931 133.486H0L0 0L131.986 0Z" fill="#222121"/>
    </svg>
    <svg class="physics-letter" width="66" height="66" viewBox="0 0 66 66" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0H65.9931V65.9931H0V0Z" fill="#222121"/>
    </svg>
    <svg class="physics-letter" width="200" height="66" viewBox="0 0 200 66" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M0 0L199.479 0V65.9931L0 65.9931L0 0Z" fill="#222121"/>
    </svg>
  </div>
</div>

<style>
  .physics-grid {
    --grid-color: var(--color-bg);
    --grid-cols: 6;
    --grid-rows: 6;
    background-image:
      linear-gradient(to right, var(--grid-color) 1px, transparent 1px),
      linear-gradient(to bottom, var(--grid-color) 1px, transparent 1px);
    background-size: calc(100% / var(--grid-cols)) calc(100% / var(--grid-rows));
    background-position: 0 0;
  }

  @media (min-width: 768px) {
    .physics-grid {
      --grid-cols: 12;
      --grid-rows: 6;
    }
  }

  @media (min-width: 1024px) {
    .physics-grid {
      --grid-cols: 14;
      --grid-rows: 7;
    }
  }

  @media (min-width: 1280px) {
    .physics-grid {
      --grid-cols: 21;
      --grid-rows: 7;
    }
  }

  .physics-grid::after {
    content: '';
    position: absolute;
    inset: 0;
    border: 1px solid var(--grid-color);
    pointer-events: none;
    z-index: 10;
  }

  .physics-letter {
    position: absolute;
    will-change: transform;
    pointer-events: none;
  }
</style>

<script>
  import Matter from 'matter-js';

  const { Engine, Render, Runner, Bodies, Composite, Body } = Matter;

  function initPhysics() {
    const container = document.getElementById('physics-container');
    const letters = document.querySelectorAll<SVGSVGElement>('.physics-letter');

    if (!container || letters.length === 0) return;

    const rect = container.getBoundingClientRect();
    const width = rect.width;
    const height = rect.height;

    // Scale proportionnel au container
    const baseScale = width / 1200;
    const scale = Math.max(0.3, Math.min(1, baseScale));

    // Créer le moteur
    const engine = Engine.create();
    const world = engine.world;

    // Gravité
    engine.gravity.y = 1;

    // Épaisseur des murs
    const wallThickness = 50;

    // Créer le bowl (murs gauche, droite, bas)
    const walls = [
      // Mur gauche
      Bodies.rectangle(
        -wallThickness / 2,
        height / 2,
        wallThickness,
        height * 2,
        { isStatic: true }
      ),
      // Mur droite
      Bodies.rectangle(
        width + wallThickness / 2,
        height / 2,
        wallThickness,
        height * 2,
        { isStatic: true }
      ),
      // Mur bas
      Bodies.rectangle(
        width / 2,
        height + wallThickness / 2,
        width + wallThickness * 2,
        wallThickness,
        { isStatic: true }
      ),
    ];

    Composite.add(world, walls);

    // Créer les corps pour chaque lettre avec leurs dimensions propres
    const bodies: Matter.Body[] = [];
    const dimensions: { width: number; height: number }[] = [];

    letters.forEach((letter, index) => {
      // Lire les dimensions originales du SVG
      const originalWidth = parseFloat(letter.getAttribute('width') || '100');
      const originalHeight = parseFloat(letter.getAttribute('height') || '100');

      // Appliquer le scale
      const letterWidth = originalWidth * scale;
      const letterHeight = originalHeight * scale;

      dimensions.push({ width: letterWidth, height: letterHeight });

      // Position initiale au-dessus du container, espacée
      const x = (width / 2) + (Math.random() - 0.5) * width * 0.6;
      const y = -letterHeight - (index * 80 * scale) - Math.random() * 100;

      const body = Bodies.rectangle(x, y, letterWidth, letterHeight, {
        restitution: 0.3,
        friction: 0.5,
        frictionAir: 0.01,
        angle: (Math.random() - 0.5) * 0.5,
      });

      bodies.push(body);
      Composite.add(world, body);

      // Appliquer l'échelle au SVG
      letter.style.width = `${letterWidth}px`;
      letter.style.height = `${letterHeight}px`;
    });

    // Boucle de rendu
    function update() {
      Engine.update(engine, 1000 / 60);

      bodies.forEach((body, index) => {
        const letter = letters[index];
        const dim = dimensions[index];
        if (letter && dim) {
          const x = body.position.x - dim.width / 2;
          const y = body.position.y - dim.height / 2;
          const angle = body.angle;

          letter.style.transform = `translate(${x}px, ${y}px) rotate(${angle}rad)`;
        }
      });

      requestAnimationFrame(update);
    }

    update();
  }

  // Init au chargement
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPhysics);
  } else {
    initPhysics();
  }

  // Re-init sur les view transitions
  document.addEventListener('astro:after-swap', initPhysics);
</script>
