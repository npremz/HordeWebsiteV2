---
const weatherTranslations = {
	loading: 'Chargement...',
	unavailable: 'Indisponible',
	days: ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'],
	codes: {
		0: ['Ensoleillé', '☀'],
		1: ['Peu nuageux', '⛅'],
		2: ['Partiellement nuageux', '☁'],
		3: ['Couvert', '☁'],
		45: ['Brouillard', '☁'],
		48: ['Brouillard givrant', '☁'],
		51: ['Bruine légère', '☂'],
		53: ['Bruine modérée', '☂'],
		55: ['Bruine dense', '☂'],
		61: ['Pluie légère', '☂'],
		63: ['Pluie modérée', '☂'],
		65: ['Pluie forte', '☂'],
		71: ['Neige légère', '❄'],
		73: ['Neige modérée', '❄'],
		75: ['Neige forte', '❄'],
		77: ['Grésil', '❄'],
		80: ['Averses légères', '☂'],
		81: ['Averses modérées', '☂'],
		82: ['Averses violentes', '☂'],
		95: ['Orage', '⚡'],
		96: ['Orage avec grêle', '⚡'],
		99: ['Orage violent', '⚡']
	}
};

interface Props
{
	class?: string;
}

const { class: className = '' } = Astro.props;
---

<div class={`flex flex-col w-full lg:flex-row ${className}`}>
	<div id="time-display" class="whitespace-nowrap w-fit">Jour --:--:--</div>
	<div id="weather-display" class="whitespace-nowrap leading-none flex gap-1.5 w-fit">Chargement...</div>
</div>

<script define:vars={{ weatherTranslations }}>
	// Configuration
	const LAT = 50.8503;
	const LON = 4.3517;

	const weatherCodes = weatherTranslations.codes;

	const days = weatherTranslations.days;

	let currentWeatherText = weatherTranslations.loading;

	function formatTime(date)
	{
		const dayName = days[date.getDay()];
		const hours = date.getHours().toString().padStart(2, '0');
		const minutes = date.getMinutes().toString().padStart(2, '0');
		const seconds = date.getSeconds().toString().padStart(2, '0');

		return `${dayName} ${hours}:${minutes}:${seconds}`;
	}

	async function fetchWeather()
	{
		try
		{
			const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&current_weather=true`);
			const data = await response.json();

			const code = data.current_weather.weathercode;
			const weatherInfo = weatherCodes[code] || [weatherTranslations.unavailable, ''];

			currentWeatherText = `${weatherInfo[0]} <span class="font-neuebit text-lg block leading-[1]">${weatherInfo[1]}</span>`;
		}
		catch (error)
		{
			console.error("Erreur météo:", error);
			currentWeatherText = weatherTranslations.unavailable;
		}

		const weatherEl = document.getElementById('weather-display');
		if (weatherEl)
		{
			weatherEl.innerHTML = `<span>(</span>` + currentWeatherText + `)`;
		}
	}

	function updateTime()
	{
		const timeEl = document.getElementById('time-display');
		if (timeEl)
		{
			const now = new Date();
			timeEl.innerText = formatTime(now);
		}
	}

	function init()
	{
		fetchWeather();
		updateTime();

		setInterval(updateTime, 1000);
		setInterval(fetchWeather, 1000 * 60 * 15);
	}

	function scheduleInit()
	{
		if ('requestIdleCallback' in window)
		{
			requestIdleCallback(() => init());
		}
		else
		{
			setTimeout(init, 0);
		}
	}

	if (document.readyState === 'complete')
	{
		scheduleInit();
	}
	else
	{
		window.addEventListener('load', scheduleInit, { once: true });
	}
</script>
