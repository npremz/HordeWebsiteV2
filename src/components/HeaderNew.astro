---
import yaml from 'js-yaml';
import fs from 'node:fs';
import path from 'node:path';
import { DEFAULT_LOCALE, type Locale, useTranslations, getLocalizedPath, getPathWithoutLocale } from '../i18n';

interface Props {
  lang?: Locale;
}

const { lang = DEFAULT_LOCALE } = Astro.props;
const t = useTranslations(lang);

// Get current path for language switcher
const currentPath = getPathWithoutLocale(Astro.url.pathname);
const switchLang = lang === 'fr' ? 'en' : 'fr';
const switchUrl = getLocalizedPath(currentPath, switchLang);

// Load navigation from localized settings
const navPath = path.join(process.cwd(), `src/content/settings_${lang}/navigation.yaml`);
let navigation: {
  logo?: string;
  logoAlt?: string;
  items?: { label: string; url: string; isExternal?: boolean }[];
  ctaButton?: { label?: string; url?: string };
} = { items: [] };

try {
  const navContent = fs.readFileSync(navPath, 'utf8');
  navigation = yaml.load(navContent) as typeof navigation;
} catch {
  try {
    const fallbackPath = path.join(process.cwd(), 'src/content/settings_fr/navigation.yaml');
    const navContent = fs.readFileSync(fallbackPath, 'utf8');
    navigation = yaml.load(navContent) as typeof navigation;
  } catch {
    // Use defaults
  }
}

const { logo, logoAlt = 'Logo', items = [], ctaButton } = navigation;
const email = 'hello@hordeagence.com';
---

<header
  id="header-new"
  class="header-new fixed z-9999999 top-0 left-0 right-0 pt-(--gutter) sm:pt-5 px-(--gutter) lg:px-0 transition-transform duration-400 ease-[cubic-bezier(0.16,1,0.3,1)]"
  data-state="visible"
>
  <!-- Header bar -->
  <div class="header-bar max-w-[1350px] mx-auto bg-black border border-lines-dark text-bg-light px-5 py-4 md:px-6 md:py-5">
    <div class="flex-between">
      <!-- Logo -->
      <a href={`/${lang}`} class="block">
        <img
          src="/images/logo_white.svg"
          alt={logoAlt}
          class="h-[17px] w-auto sm:h-auto sm:w-18"
          width="112"
          height="40"
          decoding="async"
          fetchpriority="high"
        />
      </a>

      <!-- Menu button -->
      <button
        type="button"
        id="menu-toggle-new"
        class="flex-center gap-4 cursor-pointer"
        aria-expanded="false"
        aria-controls="menu-panel"
        aria-label={t.nav.openMenu}
        data-open-label={t.nav.openMenu}
        data-close-label={t.nav.closeMenu}
        data-menu-text={t.nav.menu}
        data-close-text={t.nav.close}
      >
        <span id="menu-label-new" class="text-[1.375rem]">{t.nav.menu}</span>
        <div class="flex flex-col justify-center gap-2 w-[36px] h-4" aria-hidden="true">
          <span class="burger-line block w-full h-px bg-[#9C9C9C] transition-all duration-300 ease-out origin-center"></span>
          <span class="burger-line block w-full h-px bg-[#9C9C9C] transition-all duration-300 ease-out origin-center"></span>
        </div>
      </button>
    </div>
  </div>

  <!-- Menu panel -->
  <div
    id="menu-panel"
    class="menu-panel max-w-[1350px] mx-auto bg-black text-bg-light max-h-0 overflow-hidden transition-[max-height] duration-500 ease-[cubic-bezier(0.16,1,0.3,1)] border-x border-b border-lines-dark"
    aria-hidden="true"
  >
    <div class="p-5 md:p-6 sm:flex sm:flex-row-reverse sm:justify-between">
      <!-- Navigation links -->
      <nav class="sm:w-1/2">
        <ul class="flex flex-col gap-6">
          {items.map((item, index) => (
            <li class="menu-item opacity-0 transition-all duration-300 ease-out text-right" style={`--item-delay: ${index * 0.05}s`}>
              <a
                href={item.url}
                class="menu-link inline-block relative text-[2.5rem] leading-none text-black no-underline
                       after:content-[''] after:absolute after:bottom-0 after:left-0 after:w-full after:h-0.5 after:bg-current after:scale-x-0 after:origin-left after:transition-transform after:duration-400 after:ease-[cubic-bezier(0.25,0.46,0.45,0.94)]
                       hover:after:scale-x-100"
                target={item.isExternal ? '_blank' : undefined}
                rel={item.isExternal ? 'noopener noreferrer' : undefined}
                tabindex="-1"
              >
                {item.label}
              </a>
            </li>
          ))}
        </ul>
      </nav>

      <!-- Footer info -->
      <div class="pt-5 md:pt-0 border-t border-lines-dark sm:border-0 sm:flex sm:flex-col sm:justify-between sm:mt-0">
		<a href="/contact" class="hidden sm:flex text-[1.375rem] leading-none justify-end sm:justify-start items-center gap-2.5">
			<svg width="11" height="10" viewBox="0 0 11 10" fill="none" xmlns="http://www.w3.org/2000/svg">
				<path d="M7.38206 10L6.60058 9.24904L9.13314 6.39847L0 6.39847V0H1V5.32567H9.13314L6.60058 2.4751L7.38206 1.72414L11 5.86207L7.38206 10Z" fill="#F4F3F3"/>
			</svg>
			DÃ©marrer un projet
		</a>
        <div class="flex flex-col gap-4 text-right sm:text-left">
          <!-- Email -->
          <a
            href={`mailto:${email}`}
            class="menu-item opacity-0 flex justify-end sm:justify-start items-center gap-2.5 transition-all duration-300 ease-out leading-none text-lg font-mono uppercase no-underline hover:opacity-70"
            style="--item-delay: 0.2s"
            tabindex="-1"
          >
			<svg class="mt-1" width="11" height="10" viewBox="0 0 11 10" fill="none" xmlns="http://www.w3.org/2000/svg">
				<path d="M7.38206 10L6.60058 9.24904L9.13314 6.39847L0 6.39847V0H1V5.32567H9.13314L6.60058 2.4751L7.38206 1.72414L11 5.86207L7.38206 10Z" fill="#F4F3F3"/>
			</svg>
            {email}
          </a>

          <!-- Language switch -->
          <a
            href={switchUrl}
            class="menu-item opacity-0 flex justify-end sm:justify-start items-center gap-2.5 transition-all duration-300 ease-out leading-none text-lg font-mono uppercase no-underline hover:opacity-70"
            style="--item-delay: 0.25s"
            hreflang={switchLang}
            tabindex="-1"
          >
		  	<svg class="mt-1" width="11" height="10" viewBox="0 0 11 10" fill="none" xmlns="http://www.w3.org/2000/svg">
				<path d="M7.38206 10L6.60058 9.24904L9.13314 6.39847L0 6.39847V0H1V5.32567H9.13314L6.60058 2.4751L7.38206 1.72414L11 5.86207L7.38206 10Z" fill="#F4F3F3"/>
			</svg>

            {t.nav.switchLang}
          </a>
        </div>
      </div>
    </div>
  </div>
</header>

<style>
  /* Header visibility states */
  .header-new[data-state="hidden"] {
    transform: translateY(calc(-100% - var(--gutter)));
  }

  .header-new[data-state="visible"] {
    transform: translateY(0);
  }

  /* Burger animation - 2 lines converge to single centered line */
  .header-new.is-open .burger-line:first-child {
    transform: translateY(5px);
    opacity: 0;
  }

  .header-new.is-open .burger-line:last-child {
    transform: translateY(-5px);
  }

  /* Menu panel open */
  .header-new.is-open .menu-panel {
    max-height: 100vh;
  }

  /* Menu items animation */
  .menu-item {
    transition-delay: var(--item-delay, 0s);
  }

  .header-new.is-open .menu-item {
    opacity: 1;
    transform: translateY(0);
  }
</style>

<script>
  function initHeaderNew() {
    const header = document.getElementById('header-new');
    const toggle = document.getElementById('menu-toggle-new');
    const label = document.getElementById('menu-label-new') as HTMLElement;
    const panel = document.getElementById('menu-panel');
    const menuLinks = panel?.querySelectorAll('a');

    let isOpen = false;
    let lastScrollY = 0;
    let ticking = false;

    // Text scramble effect
    let scrambleInterval: number | null = null;
    let currentText = toggle?.dataset.menuText || 'Menu';

    function shuffleArray<T>(array: T[]): T[] {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    function scrambleText(element: HTMLElement, targetText: string) {
      if (scrambleInterval) {
        clearInterval(scrambleInterval);
      }

      let iteration = 0;
      const originalText = targetText;
      const chars = originalText.split('');

      scrambleInterval = window.setInterval(() => {
        const resolved = chars.slice(0, Math.floor(iteration));
        const remaining = chars.slice(Math.floor(iteration));
        const shuffled = shuffleArray(remaining);

        element.textContent = [...resolved, ...shuffled].join('');

        if (iteration >= originalText.length) {
          if (scrambleInterval) clearInterval(scrambleInterval);
          scrambleInterval = null;
          element.textContent = originalText;
        }

        iteration += 1 / 3;
      }, 30);
    }

    // Hover effect on menu toggle
    toggle?.addEventListener('mouseenter', () => {
      if (label) {
        scrambleText(label, currentText);
      }
    });

    function openMenu() {
      isOpen = true;
      header?.classList.add('is-open');
      panel?.setAttribute('aria-hidden', 'false');
      toggle?.setAttribute('aria-expanded', 'true');
      const closeLabel = toggle?.dataset.closeLabel || 'Close menu';
      const closeText = toggle?.dataset.closeText || 'Close';
      toggle?.setAttribute('aria-label', closeLabel);
      currentText = closeText;
      if (label) scrambleText(label, closeText);
      menuLinks?.forEach(link => link.setAttribute('tabindex', '0'));
      document.body.style.overflow = 'hidden';
    }

    function closeMenu() {
      isOpen = false;
      header?.classList.remove('is-open');
      panel?.setAttribute('aria-hidden', 'true');
      toggle?.setAttribute('aria-expanded', 'false');
      const openLabel = toggle?.dataset.openLabel || 'Open menu';
      const menuText = toggle?.dataset.menuText || 'Menu';
      toggle?.setAttribute('aria-label', openLabel);
      currentText = menuText;
      if (label) scrambleText(label, menuText);
      menuLinks?.forEach(link => link.setAttribute('tabindex', '-1'));
      document.body.style.overflow = '';
      // Reset scroll state for hide/show detection
      ticking = false;
      lastScrollY = (window as any).lenis?.scroll ?? window.scrollY;
    }

    toggle?.addEventListener('click', () => {
      isOpen ? closeMenu() : openMenu();
    });

    menuLinks?.forEach(link => {
      link.addEventListener('click', closeMenu);
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isOpen) closeMenu();
    });

    document.addEventListener('click', (e) => {
      if (isOpen && !header?.contains(e.target as Node)) {
        closeMenu();
      }
    });

    function getScrollY(): number {
      return (window as any).lenis?.scroll ?? window.scrollY;
    }

    function updateHeaderVisibility() {
      const currentScrollY = getScrollY();

      if (isOpen) {
        header?.setAttribute('data-state', 'visible');
        return;
      }

      if (currentScrollY < 50) {
        header?.setAttribute('data-state', 'visible');
      } else if (currentScrollY > lastScrollY + 5 && currentScrollY > 100) {
        header?.setAttribute('data-state', 'hidden');
      } else if (currentScrollY < lastScrollY - 5) {
        header?.setAttribute('data-state', 'visible');
      }

      lastScrollY = currentScrollY;
      ticking = false;
    }

    function onScroll() {
      if (!ticking) {
        requestAnimationFrame(updateHeaderVisibility);
        ticking = true;
      }
    }

    // Use Lenis scroll event if available, fallback to native
    if ((window as any).lenis) {
      (window as any).lenis.on('scroll', onScroll);
    } else {
      window.addEventListener('scroll', onScroll, { passive: true });
    }

    // Cleanup on navigation
    document.addEventListener('astro:before-swap', () => {
      if (scrambleInterval) {
        clearInterval(scrambleInterval);
        scrambleInterval = null;
      }
      if ((window as any).lenis) {
        (window as any).lenis.off('scroll', onScroll);
      } else {
        window.removeEventListener('scroll', onScroll);
      }
      closeMenu();
    }, { once: true });
  }

  initHeaderNew();
  document.addEventListener('astro:after-swap', initHeaderNew);
</script>
