---
import yaml from 'js-yaml';
import fs from 'node:fs';
import path from 'node:path';
import Wrapped from './ui/Wrapped.astro';

interface Props {
  variant?: 'light' | 'dark';
}

const { variant = 'light' } = Astro.props;
const isDark = variant === 'dark';

const navPath = path.join(process.cwd(), 'src/content/settings/navigation.yaml');
const navContent = fs.readFileSync(navPath, 'utf8');
const navigation = yaml.load(navContent) as {
  logo?: string;
  logoAlt?: string;
  items?: { label: string; url: string; isExternal?: boolean }[];
  ctaButton?: { label?: string; url?: string };
};

const { logo, logoAlt = 'Logo', items = [], ctaButton } = navigation;
const currentLogo = isDark ? '/images/logo_white.svg' : logo;
const textColorClass = isDark ? 'text-bg-light' : 'text-black';
---

<header class="fixed z-9999999 top-0 left-0 right-0 px-4 sm:px-8 md:px-4 lg:px-12 py-5 xl:py-12" style="view-transition-name: header;">
  <div class="flex-between">
    <a href="/" class="block">
      {currentLogo ? (
        <img
          src={currentLogo}
          alt={logoAlt}
          class="logo-size"
          width="112"
          height="40"
          decoding="async"
          fetchpriority="high"
        />
      ) : (
        <span class={`${textColorClass} font-display text-xl`}>{logoAlt}</span>
      )}
    </a>

    <div class="relative">
      <button
        type="button"
        id="menu-toggle"
        class={`flex-center gap-2 cursor-pointer ${textColorClass}`}
        aria-expanded="false"
        aria-controls="mobile-menu"
        aria-label="Ouvrir le menu"
      >
        <span id="menu-label" class="tracking-wide sm:text-[1.625rem] md:text-[2rem]">Menu</span>
        <Wrapped padding="0.5rem" class='sm:mt-1 md:mt-2' variant={variant}>
          <span id="menu-icon" class="leading-none font-mono">+</span>
        </Wrapped>
      </button>

      <div
        id="mobile-menu"
        class="absolute top-full right-0 mt-4 origin-top-right"
        aria-hidden="true"
      >
        <nav class="px-5 py-5 bg-white flex-col-container gap-4">
          <ul class="flex-col-container gap-4">
            {items.map((item, index) => (
              <li class="menu-item" style={`--item-delay: ${0.05 + index * 0.04}s`}>
                <a
                  href={item.url}
                  class="menu-link text-black text-3xl font-sans link-hover whitespace-nowrap block"
                  target={item.isExternal ? '_blank' : undefined}
                  rel={item.isExternal ? 'noopener noreferrer' : undefined}
                >
                  {item.label}
                </a>
              </li>
            ))}
          </ul>
          <span class="divider-lines menu-item" style={`--item-delay: ${0.05 + items.length * 0.04}s`}></span>

          {ctaButton?.label && ctaButton?.url && (
            <div class="menu-item" style={`--item-delay: ${0.05 + (items.length + 1) * 0.04}s`}>
              <a
                href={ctaButton.url}
                class="menu-link tracking-wide link-hover-subtle"
              >
                {ctaButton.label}
              </a>
            </div>
          )}
        </nav>
      </div>
    </div>
  </div>
</header>

<style is:global>
  #mobile-menu {
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }

  #mobile-menu.is-open {
    opacity: 1;
    pointer-events: auto;
  }

  .menu-item {
    opacity: 0;
    transition: opacity 0.25s ease;
  }

  #mobile-menu.is-open .menu-item {
    opacity: 1;
    transition-delay: var(--item-delay);
  }
</style>

<script>
  function initMenu() {
    const toggle = document.getElementById('menu-toggle');
    const menu = document.getElementById('mobile-menu');
    const label = document.getElementById('menu-label');
    const icon = document.getElementById('menu-icon');
    const links = document.querySelectorAll('.menu-link');
    let isOpen = false;

    function open() {
      isOpen = true;
      menu?.classList.add('is-open');
      menu?.setAttribute('aria-hidden', 'false');
      toggle?.setAttribute('aria-expanded', 'true');
      toggle?.setAttribute('aria-label', 'Fermer le menu');
      if (label) label.textContent = 'Close';
      if (icon) icon.textContent = '-';
      document.body.style.overflow = 'hidden';
    }

    function close() {
      isOpen = false;
      menu?.classList.remove('is-open');
      menu?.setAttribute('aria-hidden', 'true');
      toggle?.setAttribute('aria-expanded', 'false');
      toggle?.setAttribute('aria-label', 'Ouvrir le menu');
      if (label) label.textContent = 'Menu';
      if (icon) icon.textContent = '+';
      document.body.style.overflow = '';
    }

    toggle?.addEventListener('click', (e) => {
      e.stopPropagation();
      isOpen ? close() : open();
    });
    links.forEach(link => link.addEventListener('click', close));
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isOpen) close();
    });
    document.addEventListener('click', (e) => {
      if (isOpen && !menu?.contains(e.target as Node) && !toggle?.contains(e.target as Node)) {
        close();
      }
    });
  }

  initMenu();
  document.addEventListener('astro:after-swap', initMenu);
</script>
