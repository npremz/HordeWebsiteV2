---
import yaml from 'js-yaml';
import fs from 'node:fs';
import path from 'node:path';
import Wrapped from './ui/Wrapped.astro';

interface Props {
  variant?: 'light' | 'dark';
}

const { variant = 'light' } = Astro.props;
const isDark = variant === 'dark';

const navPath = path.join(process.cwd(), 'src/content/settings/navigation.yaml');
const navContent = fs.readFileSync(navPath, 'utf8');
const navigation = yaml.load(navContent) as {
  logo?: string;
  logoAlt?: string;
  items?: { label: string; url: string; isExternal?: boolean }[];
  ctaButton?: { label?: string; url?: string };
};

const { logo, logoAlt = 'Logo', items = [], ctaButton } = navigation;
const currentLogo = isDark ? '/images/logo_white.svg' : logo;
const textColorClass = isDark ? 'text-bg-light' : 'text-black';
---

<header class="fixed z-9999999 top-0 left-0 right-0 px-4 sm:px-8 md:px-4 lg:px-12 py-5 xl:py-10 2xl:py-10" style="view-transition-name: header;">
  <div class="flex-between">
    <a href="/" class="block">
      {currentLogo ? (
        <img
          src={currentLogo}
          alt={logoAlt}
          class="logo-size"
          width="112"
          height="40"
          decoding="async"
          fetchpriority="high"
        />
      ) : (
        <span class={`${textColorClass} font-display text-xl`}>{logoAlt}</span>
      )}
    </a>

    <div class="flex gap-16"> 
      <a href="/contact" class="sm:text-[1.625rem] md:text-[2rem] nav-scramble nav-link-hover hidden! md:inline-block!" data-text="Démarrer un projet">Démarrer un projet</a>
      <div class="relative">
        <button
          type="button"
          id="menu-toggle"
          class={`flex-center gap-2 cursor-pointer ${textColorClass}`}
          aria-expanded="false"
          aria-controls="mobile-menu"
          aria-label="Ouvrir le menu"
        >
          <span id="menu-label" class=" sm:text-[1.625rem] md:text-[2rem]" data-scramble>Menu</span>
          <Wrapped padding="0.5rem" class='sm:mt-1 md:mt-2' variant={variant}>
            <span id="menu-icon" class="leading-none font-mono">+</span>
          </Wrapped>
        </button>

        <div
          id="mobile-menu"
          class="absolute top-full right-0 mt-4 origin-top-right"
          aria-hidden="true"
        >
          <nav class="px-5 py-5 sm:p-[2.5rem] flex-col-container gap-4 sm:w-[450px]">
            <ul class="flex-col-container gap-4">
              {items.map((item, index) => (
                <li class="menu-item" style={`--item-delay: ${0.05 + index * 0.04}s`}>
                  <a
                    href={item.url}
                    class="menu-link nav-scramble text-black! text-3xl sm:text-[3.5625rem] font-sans nav-link-hover whitespace-nowrap block tracking-[-0.02em] w-fit"
                    target={item.isExternal ? '_blank' : undefined}
                    rel={item.isExternal ? 'noopener noreferrer' : undefined}
                    data-text={item.label}
                    tabindex="-1"
                  >
                    {item.label}
                  </a>
                </li>
              ))}
            </ul>
            <span class="divider-lines menu-item sm:my-[1.25rem]" style={`--item-delay: ${0.05 + items.length * 0.04}s`}></span>

            <div class="menu-item flex flex-col gap-[0.625rem]" style={`--item-delay: ${0.05 + (items.length + 1) * 0.04}s`}>
              {ctaButton?.label && ctaButton?.url && (
                <a
                  href={ctaButton.url}
                  class="menu-link text-black! tracking-[-0.02em] nav-link-cta sm:text-[2rem] w-fit"
                  tabindex="-1"
                >
                  {ctaButton.label}
                </a>
              )}
              <button
                type="button"
                class="menu-link text-black! tracking-[-0.02em] nav-link-hover sm:text-[2rem] text-left w-fit"
                tabindex="-1"
              >
                English version
              </button>
            </div>
          </nav>
        </div>
      </div>
    </div>
  </div>
</header>

<style is:global>
  .nav-link-cta {
    position: relative;
    display: inline-block;
    border-bottom: 1px solid var(--color-lines);
  }

  .nav-link-cta::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 0;
    width: 100%;
    height: 1px;
    background-color: currentColor;
    transform: scaleX(0);
    transform-origin: left center;
    transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }

  .nav-link-cta:hover::after {
    transform: scaleX(1);
  }

  .nav-link-hover {
    position: relative;
    display: inline-block;
  }

  .nav-link-hover::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 1px;
    background-color: currentColor;
    transform: scaleX(0);
    transform-origin: left center;
    transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }

  .nav-link-hover:hover::after {
    transform: scaleX(1);
  }

  #mobile-menu {
    pointer-events: none;
  }

  #mobile-menu.is-open {
    pointer-events: auto;
  }

  #mobile-menu nav {
    position: relative;
    overflow: hidden;
  }

  #mobile-menu nav::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: white;
    transform: scaleY(0);
    transform-origin: top center;
    transition: transform 0.4s ease-out;
    z-index: -1;
  }

  #mobile-menu.is-open nav::before {
    transform: scaleY(1);
  }

  .menu-item {
    opacity: 0;
    transition: opacity 0.25s ease;
  }

  #mobile-menu.is-open .menu-item {
    opacity: 1;
    transition-delay: var(--item-delay);
  }
</style>

<script>
  function initMenu() {
    const toggle = document.getElementById('menu-toggle');
    const menu = document.getElementById('mobile-menu');
    const label = document.getElementById('menu-label') as HTMLElement;
    const icon = document.getElementById('menu-icon');
    const links = document.querySelectorAll('.menu-link');
    let isOpen = false;

    // Text scramble effect
    let scrambleInterval: number | null = null;
    const scrambleIntervals = new Map<HTMLElement, number>();
    let currentText = 'Menu';

    // Fonction pour mélanger un tableau
    function shuffleArray<T>(array: T[]): T[] {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    function scrambleText(element: HTMLElement, targetText: string) {
      if (scrambleInterval) {
        clearInterval(scrambleInterval);
      }

      let iteration = 0;
      const originalText = targetText;
      const chars = originalText.split('');

      scrambleInterval = window.setInterval(() => {
        // Lettres déjà résolues (fixes)
        const resolved = chars.slice(0, Math.floor(iteration));
        // Lettres pas encore résolues (à mélanger)
        const remaining = chars.slice(Math.floor(iteration));
        const shuffled = shuffleArray(remaining);

        element.textContent = [...resolved, ...shuffled].join('');

        if (iteration >= originalText.length) {
          if (scrambleInterval) clearInterval(scrambleInterval);
          scrambleInterval = null;
          element.textContent = originalText;
        }

        iteration += 1 / 3;
      }, 30);
    }

    function scrambleNavLink(element: HTMLElement, targetText: string) {
      // Arrêter l'animation précédente si elle existe
      const existingInterval = scrambleIntervals.get(element);
      if (existingInterval) {
        clearInterval(existingInterval);
      }

      let iteration = 0;
      const originalText = targetText;
      const chars = originalText.split('');

      const intervalId = window.setInterval(() => {
        const resolved = chars.slice(0, Math.floor(iteration));
        const remaining = chars.slice(Math.floor(iteration));
        const shuffled = shuffleArray(remaining);

        element.textContent = [...resolved, ...shuffled].join('');

        if (iteration >= originalText.length) {
          clearInterval(intervalId);
          scrambleIntervals.delete(element);
          element.textContent = originalText;
        }

        iteration += 1;
      }, 20);

      scrambleIntervals.set(element, intervalId);
    }

    // Hover effect on menu toggle
    toggle?.addEventListener('mouseenter', () => {
      if (label) {
        scrambleText(label, currentText);
      }
    });

    // Hover effect on nav links
    const navScrambleLinks = document.querySelectorAll('.nav-scramble');
    navScrambleLinks.forEach((link) => {
      link.addEventListener('mouseenter', () => {
        const text = (link as HTMLElement).dataset.text || link.textContent || '';
        scrambleNavLink(link as HTMLElement, text);
      });
    });

    function open() {
      isOpen = true;
      menu?.classList.add('is-open');
      menu?.setAttribute('aria-hidden', 'false');
      toggle?.setAttribute('aria-expanded', 'true');
      toggle?.setAttribute('aria-label', 'Fermer le menu');
      currentText = 'Close';
      if (label) scrambleText(label, 'Close');
      if (icon) icon.textContent = '-';
      document.body.style.overflow = 'hidden';
      // Rendre les liens focusables
      links.forEach(link => link.setAttribute('tabindex', '0'));
    }

    function close() {
      isOpen = false;
      menu?.classList.remove('is-open');
      menu?.setAttribute('aria-hidden', 'true');
      toggle?.setAttribute('aria-expanded', 'false');
      toggle?.setAttribute('aria-label', 'Ouvrir le menu');
      currentText = 'Menu';
      if (label) scrambleText(label, 'Menu');
      if (icon) icon.textContent = '+';
      document.body.style.overflow = '';
      // Retirer les liens du focus quand menu fermé
      links.forEach(link => link.setAttribute('tabindex', '-1'));
    }

    toggle?.addEventListener('click', (e) => {
      e.stopPropagation();
      isOpen ? close() : open();
    });
    links.forEach(link => link.addEventListener('click', close));
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isOpen) close();
    });
    document.addEventListener('click', (e) => {
      if (isOpen && !menu?.contains(e.target as Node) && !toggle?.contains(e.target as Node)) {
        close();
      }
    });

    // Cleanup on view transitions
    document.addEventListener('astro:before-swap', () => {
      if (scrambleInterval) {
        clearInterval(scrambleInterval);
        scrambleInterval = null;
      }
      scrambleIntervals.forEach((id) => clearInterval(id));
      scrambleIntervals.clear();
    }, { once: true });
  }

  initMenu();
  document.addEventListener('astro:after-swap', initMenu);
</script>
