---
import Wrapped from "../ui/Wrapped.astro";
import { DEFAULT_LOCALE, type Locale, useTranslations } from "../../i18n";

interface Props {
	lang?: Locale;
}

const { lang = DEFAULT_LOCALE } = Astro.props;
const t = useTranslations(lang);

const projects = [
	{
		name: "Café Belga",
		href: "https://belga.hordagency.com",
		image: "/images/projects/belga.jpg",
		inProgress: false,
	},
	{
		name: "Merly",
		href: null,
		image: null,
		inProgress: true,
	},
	{
		name: "E-Putch",
		href: null,
		image: null,
		inProgress: true,
	},
];
---

<div class="flex flex-col">
	<div
		class="flex font-display gap-4 leading-none items-end text-[1.625rem] sm:text-[2.5rem] md:text-[3.125rem] lg:text-[4rem] uppercase"
	>
		<h2 set:html={t.projects.title.replace(/\n/g, "<br>")} />
		<span
			class="block font-mono text-[1rem] uppercase -translate-y-1 md:-translate-y-2"
			>({String(projects.length).padStart(2, "0")})</span
		>
	</div>
	<a
		href={`/${lang}/projects`}
		class="hidden section-label text-[1rem] leading-none self-end mt-10 sm:mt-0 lg:-mt-[1lh]"
		><Wrapped>{t.projects.otherProjects} →</Wrapped></a
	>

	<!-- Image flottante qui suit la souris (desktop only) -->
	<div
		id="project-hover-image"
		class="hidden md:block pointer-events-none fixed z-50 overflow-visible"
		style="transform: translate(-50%, -50%) scale(0); will-change: transform;"
	>
		<div class="w-[315px] h-[315px] overflow-hidden">
			<img
				id="project-hover-img"
				src=""
				alt=""
				class="w-full h-full object-cover"
			/>
			<div
				id="project-hover-placeholder"
				class="hidden w-full h-full bg-bg-light border border-lines flex items-center justify-center"
			>
				<span class="section-label">{t.projects.inProgress}</span>
			</div>
		</div>
	</div>

	<ol class="mt-10 sm:mt-16 text-[2rem] lg:text-[2.5rem]">
		{
			projects.map((project, index) => (
				<li
					class="project-item"
					data-image={project.image || ""}
					data-in-progress={project.inProgress}
				>
					{project.href ? (
						<a
							href={project.href}
							target="_blank"
							class:list={[
								"project-link flex justify-between py-8 px-9",
								index === 0
									? "border border-lines"
									: "border-b border-x border-lines",
							]}
						>
							<p>{project.name}</p>
							<Wrapped class="text-[1rem] font-mono">→</Wrapped>
						</a>
					) : (
						<div
							class:list={[
								"project-link flex justify-between py-8 px-9",
								index === 0
									? "border border-lines"
									: "border-b border-x border-lines",
							]}
						>
							<p>
								{project.name}{" "}
								<span class="section-label">
									{t.projects.inProgress}
								</span>
							</p>
							<Wrapped class="text-[1rem] font-mono">→</Wrapped>
						</div>
					)}
				</li>
			))
		}
	</ol>
</div>

<style>
	.project-item {
		position: relative;
	}

	.project-link {
		position: relative;
		isolation: isolate;
		transition: color 0.3s ease-out;
	}

	.project-link::before {
		content: "";
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background-color: var(--color-black);
		z-index: -1;
		transform: scaleX(0);
		transform-origin: left center;
		transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
	}

	@media (hover: hover) {
		.project-link:hover {
			color: var(--color-bg-light);
		}

		.project-link:hover::before {
			transform: scaleX(1);
		}

		.project-link :global(.wrapped) {
			transition: color 0.3s ease-out 0.2s;
		}

		.project-link:hover :global(.wrapped) {
			color: var(--color-bg-light) !important;
		}
	}
</style>

<script>
	function initProjectHoverImage() {
		// Désactiver sur mobile/touch
		const isMobile =
			window.matchMedia("(max-width: 768px)").matches ||
			"ontouchstart" in window;
		if (isMobile || !window.matchMedia("(hover: hover)").matches) return;

		const container = document.getElementById("project-hover-image");
		const img = document.getElementById(
			"project-hover-img",
		) as HTMLImageElement;
		const placeholder = document.getElementById(
			"project-hover-placeholder",
		);
		const projectItems = document.querySelectorAll(".project-item");

		if (!container || !img || !placeholder) return;

		let mouseX = 0;
		let mouseY = 0;
		let currentX = 0;
		let currentY = 0;
		let velocityX = 0;
		let currentRotation = 0;
		let targetRotation = 0;
		let currentScale = 0;
		let targetScale = 0;
		let isHovering = false;
		let animationId: number | null = null;

		function animate() {
			const posEase = 0.1;
			const scaleEase = 0.08;
			const rotEase = 0.06;

			// Position
			const prevX = currentX;
			currentX += (mouseX - currentX) * posEase;
			currentY += (mouseY - currentY) * posEase;

			// Vélocité pour l'inertie
			velocityX = currentX - prevX;

			// Inertie : rotation basée sur la vélocité (max ±12deg)
			const inertiaRotation = Math.max(
				-12,
				Math.min(12, velocityX * 2.5),
			);
			targetRotation = isHovering ? inertiaRotation : 0;

			// Scale
			currentScale += (targetScale - currentScale) * scaleEase;

			// Force scale to 0 when very small and target is 0
			if (targetScale === 0 && currentScale < 0.01) {
				currentScale = 0;
			}

			// Rotation avec inertie
			currentRotation += (targetRotation - currentRotation) * rotEase;

			container.style.left = `${currentX}px`;
			container.style.top = `${currentY}px`;
			container.style.transform = `translate(-50%, -50%) scale(${currentScale}) rotate(${currentRotation}deg)`;
			container.style.opacity =
				targetScale === 0 && currentScale < 0.01 ? "0" : "1";

			const isAnimating =
				Math.abs(currentX - mouseX) > 0.1 ||
				Math.abs(currentY - mouseY) > 0.1 ||
				Math.abs(currentScale - targetScale) > 0.01 ||
				Math.abs(currentRotation - targetRotation) > 0.1;

			if (isAnimating) {
				animationId = requestAnimationFrame(animate);
			} else {
				animationId = null;
			}
		}

		function startAnimation() {
			if (!animationId) {
				animationId = requestAnimationFrame(animate);
			}
		}

		let currentElement: HTMLElement | null = null;

		function showImage(element: HTMLElement) {
			const imageSrc = element.dataset.image;
			const inProgress = element.dataset.inProgress === "true";

			if (inProgress || !imageSrc) {
				img.classList.add("hidden");
				placeholder.classList.remove("hidden");
			} else {
				img.src = imageSrc;
				img.classList.remove("hidden");
				placeholder.classList.add("hidden");
			}
		}

		projectItems.forEach((item) => {
			const element = item as HTMLElement;

			element.addEventListener("mouseenter", () => {
				isHovering = true;

				// Si on change d'élément, reset l'animation
				if (currentElement !== element) {
					currentX = mouseX;
					currentY = mouseY;
					currentScale = 0;
					currentRotation = 0;
				}

				currentElement = element;
				showImage(element);
				targetScale = 1;
				startAnimation();
			});

			element.addEventListener("mouseleave", () => {
				isHovering = false;
				currentElement = null;
				targetScale = 0;
				startAnimation();
			});

			element.addEventListener("mousemove", (e) => {
				mouseX = e.clientX;
				mouseY = e.clientY;
				startAnimation();
			});
		});

		// Cleanup
		document.addEventListener(
			"astro:before-swap",
			() => {
				if (animationId) {
					cancelAnimationFrame(animationId);
				}
			},
			{ once: true },
		);
	}

	initProjectHoverImage();
	document.addEventListener("astro:after-swap", initProjectHoverImage);
</script>
