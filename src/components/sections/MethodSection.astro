--- 
interface Props {
	title?: string;
	stepsCount?: string;
	steps?: string[];
}

const {
	title = '<span>Nos 03</span><span>méthodes</span>',
	stepsCount = '03',
	steps = [
		'Eliminer les frictions pénalisantes',
		'Maximiser les conversions',
		"Soigner l'expérience utilisateur",
	],
} = Astro.props;

const svgs = [
	`<svg class="w-full lg:h-full" viewBox="0 0 494 412" fill="none" xmlns="http://www.w3.org/2000/svg">
		<path d="M411.667 0H329.333V247.2H411.667V0Z" fill="#222121"/>
		<path d="M247 0H164.667V247.2H247V0Z" fill="#222121"/>
		<path d="M82.3333 0H0V247.2H82.3333V0Z" fill="#222121"/>
		<path d="M494 247.2H411.667V412H494V247.2Z" fill="#222121"/>
		<path d="M329.333 247.2H247V412H329.333V247.2Z" fill="#222121"/>
		<path d="M164.667 247.2H82.3333V412H164.667V247.2Z" fill="#222121"/>
	</svg>`,
	`<svg class="w-full lg:h-full"  viewBox="0 0 494 412" fill="none" xmlns="http://www.w3.org/2000/svg">
		<path d="M164.667 164.8H329.333V247.2H164.667V164.8Z" fill="#222121"/>
		<path d="M494 247.2V412H411.667V329.6H329.333V247.2H494Z" fill="#222121"/>
		<path d="M0 164.8L1.43956e-05 0L82.3333 7.20364e-06L82.3333 82.4L164.667 82.4L164.667 164.8H0Z" fill="#222121"/>
		<path d="M164.667 247.2V329.6H82.3333V412H0V247.2H164.667Z" fill="#222121"/>
		<path d="M329.333 164.8V82.4H411.667V7.20364e-06L494 1.44073e-05V164.8H329.333Z" fill="#222121"/>
	</svg>`,
	`<svg class="w-full lg:h-full"  viewBox="0 0 494 412" fill="none" xmlns="http://www.w3.org/2000/svg">
		<path d="M0 0H82.3334V82.3999H0V0Z" fill="#222121"/>
		<path d="M0 164.8H82.3334V247.2H0V164.8Z" fill="#222121"/>
		<path d="M411.667 0H494V82.3999H411.667V0Z" fill="#222121"/>
		<path d="M411.667 164.799H494V247.199H411.667V164.799Z" fill="#222121"/>
		<path d="M164.667 329.599H329.333V411.999H164.667V329.599Z" fill="#222121"/>
		<path d="M411.667 329.6H494V412H411.667V329.6Z" fill="#222121"/>
		<path d="M0 329.6H82.3334V412H0V329.6Z" fill="#222121"/>
		<path d="M82.3253 82.4019H164.659V164.802H82.3253V82.4019Z" fill="#222121"/>
		<path d="M164.667 0H329.333V82.3998H164.667V0Z" fill="#222121"/>
		<path d="M329.333 247.201L411.667 247.199V329.6L329.333 329.599V247.201Z" fill="#222121"/>
		<path d="M329.333 82.3998L411.667 82.3999V164.799L329.333 164.8V82.3998Z" fill="#222121"/>
		<path d="M82.3253 247.201H164.659V329.6H82.3253V247.201Z" fill="#222121"/>
	</svg>`
]
---

<div class="relative flex-col-container justify-center items-center content-gap overflow-hidden">
	<div class="relative w-full gap-4">
		<span class="font-mono text-[14px] leading-none absolute top-0 right-0">(↓)</span>
		<h2 class="heading-display-sm text-[1.625rem] sm:text-[2.5rem] md:text-[4rem] lg:text-[6rem] xl:text-[7.5rem] flex flex-col *:block *:w-fit [&>*:first-child]:self-start [&>*:last-child]:self-end" set:html={title.replace(/\n/g, '<br>')}/>
		<span class="font-mono text-[14px] leading-none absolute bottom-0 left-0">({stepsCount})</span>
	</div>
	<div class="w-full border border-lines overflow-hidden py-12 sm:py-16 lg:pt-30 bg-[#D0CDCB]">
		<ul class="carousel-track flex flex-row gap-[3.75rem] -ml-px overflow-x-auto scrollbar-hide snap-x snap-mandatory cursor-grab active:cursor-grabbing">
			{steps.map((step, index) => (
				<li class:list={[ 
                    'carousel-item snap-start shrink-0 h-80 w-64 sm:h-154 sm:w-112 md:h-160 md:w-136 lg:w-260 border border-lines p-[1.875rem] flex flex-col justify-between lg:flex-row bg-[#F4F3F3]' 
                ]}> 
					<div class="w-full lg:h-full" set:html={svgs[index]}>
					</div>
					<div class="flex justify-between items-end lg:flex-col">
						<div class="leading-[1.1] sm:text-[1.625rem] md:text-[2rem] sm:max-w-45 lg:max-w-none lg:text-right">
							{step}
						</div>
						<div class="font-display leading-[0.7] text-[4rem] sm:text-[7.5rem] shrink-0">
							{String(index + 1).padStart(2, '0')}
						</div>
					</div>
				</li>
			))}
            <li class="carousel-spacer shrink-0 w-[50vw]"></li>
		</ul>
	</div>
</div>

<style>
	.scrollbar-hide::-webkit-scrollbar {
		display: none;
	}
	.scrollbar-hide {
		-ms-overflow-style: none;
		scrollbar-width: none;
	}

    .carousel-track {
        -webkit-overflow-scrolling: touch;
        scroll-behavior: smooth;
    }
</style>

<script>
	function initCarousel() {
		const track = document.querySelector('.carousel-track') as HTMLElement;
		const items = document.querySelectorAll('.carousel-item');
		
		if (!track || items.length === 0) return;

		let intervalId: number;
		let isAutoPlaying = true;
		const AUTO_PLAY_DELAY = 4000;

		function getAccumulatedWidths() {
            const widths = [0];
            let sum = 0;
            for (let i = 0; i < items.length - 1; i++) {
                sum += items[i].clientWidth + 20; // 20 is the gap
                widths.push(sum);
            }
            return widths;
        }

		function autoPlay() {
			if (!isAutoPlaying) return;

			const scrollLeft = Math.round(track.scrollLeft);
            const widths = getAccumulatedWidths();
            
            // Find current item index (closest)
            let currentIdx = 0;
            let minDiff = Infinity;
            widths.forEach((pos, idx) => {
                const diff = Math.abs(scrollLeft - pos);
                if (diff < minDiff) {
                    minDiff = diff;
                    currentIdx = idx;
                }
            });

            const nextIdx = (currentIdx + 1) % items.length;
            track.scrollTo({ left: widths[nextIdx], behavior: 'smooth' });
		}

		function startAutoPlay() {
			stopAutoPlay();
			intervalId = window.setInterval(autoPlay, AUTO_PLAY_DELAY);
		}

		function stopAutoPlay() {
			if (intervalId) clearInterval(intervalId);
		}

		track.addEventListener('mouseenter', () => {
			isAutoPlaying = false;
			stopAutoPlay();
		});

		track.addEventListener('mouseleave', () => {
			isAutoPlaying = true;
			startAutoPlay();
		});

		track.addEventListener('touchstart', () => {
			isAutoPlaying = false;
			stopAutoPlay();
		}, { passive: true });

		// Drag to scroll (desktop)
		let isDown = false;
		let startX: number;
		let scrollLeft: number;

		track.addEventListener('mousedown', (e) => {
			isDown = true;
			isAutoPlaying = false;
			stopAutoPlay();
			startX = e.pageX - track.offsetLeft;
			scrollLeft = track.scrollLeft;
            track.style.scrollBehavior = 'auto';
		});

		window.addEventListener('mouseup', () => {
            if (isDown) {
                isDown = false;
                track.style.scrollBehavior = 'smooth';
            }
		});

		track.addEventListener('mousemove', (e) => {
			if (!isDown) return;
			e.preventDefault();
			const x = e.pageX - track.offsetLeft;
			const walk = (x - startX) * 2;
			track.scrollLeft = scrollLeft - walk;
		});

		startAutoPlay();
	}

	document.addEventListener('astro:page-load', initCarousel);
	initCarousel();
</script>